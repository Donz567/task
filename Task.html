<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modern Task Manager</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
body {
    background-color: #f8fafc;
    color: #1a1a1a;
    font-family: 'Segoe UI', Tahoma, sans-serif;
}
.navbar {
    background: #ffffff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.task-card {
    border-radius: 12px;
    padding: 15px;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    background-color: #ffffff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}
.task-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}
.task-title {
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 5px;
}
.task-info {
    font-size: 0.85rem;
    margin-bottom: 3px;
}
.status-badge {
    padding: 4px 8px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-block;
}
.status-completed { background: #bcddc9; color: #1a1a1a; }
.status-ongoing { background: #d9eafd; color: #1a1a1a; }
.status-cancelled { background: #fdd9d9; color: #1a1a1a; }
.status-assigned { background: #f5f5d9; color: #1a1a1a; }
.bc-btn {
    background: #1a1a1a;
    color: #fff;
    text-decoration: none;
    border-radius: 8px;
    padding: 5px 10px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin-top: auto;
}
.bc-btn:hover { background: #333; text-decoration: none; }
#filterBar { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
#taskList { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr)); gap: 1rem; }

.label-badge {
    padding: 1px 5px;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-block;
    color: #1a1a1a;
    margin-bottom: 2px;
}

/* only for text background */
.label-task-text { background-color: #ffd54f; }
.label-subtask-text { background-color: #81c784; }
.label-brand-text { background-color: #64b5f6; }

/* Detail view styling */
#taskDetail {
    display: none;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 20px;
    margin-top: 20px;
}
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg sticky-top p-3">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">ðŸ“‹ Task Manager</a>
    <div class="ms-auto d-flex align-items-center gap-2 flex-wrap">
      <div id="loginDropdownContainer"></div>
      <button class="btn btn-outline-danger btn-sm" id="logoutBtn" style="display:none;">Logout</button>
      <small class="text-muted ms-3" id="lastUpdated"></small>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div id="filterBar">
    <input type="text" id="searchBar" class="form-control form-control-sm" placeholder="Search tasks">
    <select id="statusFilter" class="form-select form-select-sm">
      <option value="all" selected>All Status / SBS</option>
    </select>
  </div>
  <div id="taskList" class="mb-4"></div>
  
  <!-- Detail view panel -->
  <div id="taskDetail"></div>
  
  <nav>
    <ul class="pagination justify-content-center" id="pagination"></ul>
  </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/1AEFog4va5g5Teg5yiOamSlwwlB4g-UOGT0NUkgz7UBA/gviz/tq?tqx=out:json";

let tasks = [];
let agents = new Set();
let sbsSet = new Set();
let currentPage = 1;
let lastTaskCount = 0;   // track previously seen tasks
let newTaskCount = 0;    // for favicon badge
const tasksPerPage = 20;

document.addEventListener("DOMContentLoaded", () => {
    initApp();
    document.getElementById("searchBar").addEventListener("input", () => { currentPage = 1; filterTasks(); });
    document.getElementById("statusFilter").addEventListener("change", () => { currentPage = 1; filterTasks(); });
    document.getElementById("logoutBtn").addEventListener("click", logout);
    setInterval(() => { fetchTasks().then(() => filterTasks(true)); }, 30000);
});

async function initApp() {
    await fetchTasks();
    setupLogin();
    setupStatusFilter();
    filterTasks();
}

function parseSheetDate(value) {
    if (!value) return new Date(0);
    if (!isNaN(value)) {
        const epoch = new Date(1899, 11, 30);
        return new Date(epoch.getTime() + Number(value) * 24*60*60*1000);
    }
    const parts = value.split("/");
    if (parts.length === 3) {
        const month = parseInt(parts[0],10)-1;
        const day = parseInt(parts[1],10);
        const year = parseInt(parts[2],10);
        const date = new Date(year, month, day);
        if (!isNaN(date.getTime())) return date;
    }
    return new Date(0);
}

async function fetchTasks() {
    try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        tasks = json.table.rows.map((row,i) => {
            let obj = {};
            json.table.cols.forEach((col,j) => { obj[col.label] = row.c[j] ? row.c[j].v : ""; });
            obj["_id"] = i;
            if(obj["Agent Assigned"]) agents.add(obj["Agent Assigned"]);
            if(obj["TM's Note"]) sbsSet.add(obj["TM's Note"]);
            obj._dateParsed = parseSheetDate(obj["Date Assigned"]);
            return obj;
        });
        tasks.sort((a,b) => a._id - b._id);
        tasks.reverse();
        // Count current assigned tasks for the logged-in agent
        const loginName = localStorage.getItem("agent");
        if (loginName) {
            const currentCount = tasks.filter(t => t["Agent Assigned"] === loginName).length;

            if (lastTaskCount > 0 && currentCount > lastTaskCount) {
                // new task(s) assigned since last fetch
                newTaskCount += (currentCount - lastTaskCount);
                updateFavicon(newTaskCount);
            }

            lastTaskCount = currentCount;
        }

        updateLastUpdated();
    } catch(err) { console.error("Error fetching tasks:", err); }
}

function setupLogin() {
    const loginName = localStorage.getItem("agent");
    if(loginName){
        document.getElementById("logoutBtn").style.display="inline-block";
        document.getElementById("loginDropdownContainer").innerHTML=`<span class="fw-bold text-primary">${loginName}</span>`;
    } else {
        let dropdownHTML = `<select class="form-select form-select-sm" id="loginDropdown"><option selected disabled>Login as...</option>`;
        agents.forEach(agent => { dropdownHTML += `<option value="${agent}">${agent}</option>`; });
        dropdownHTML += `</select>`;
        document.getElementById("loginDropdownContainer").innerHTML = dropdownHTML;
        document.getElementById("loginDropdown").addEventListener("change", (e) => {
            localStorage.setItem("agent", e.target.value);
            location.reload();
        });
    }
}

function setupStatusFilter(){
    const statusFilter = document.getElementById("statusFilter");
    const statuses = ["ongoing","completed","cancelled","assigned"];
    statuses.forEach(s => { statusFilter.innerHTML += `<option value="${s}">${capitalize(s)}</option>`; });
    Array.from(sbsSet).forEach(sbs => { statusFilter.innerHTML += `<option value="SBS:${sbs}">${sbs}</option>`; });
}

function capitalize(str){ return str.charAt(0).toUpperCase() + str.slice(1); }

function filterTasks(isRefresh=false){
    const loginName = localStorage.getItem("agent");
    if(!loginName) return;
    const search = document.getElementById("searchBar").value.toLowerCase();
    const statusFilter = document.getElementById("statusFilter").value;
    let filtered = tasks.filter(t => t["Agent Assigned"]===loginName);
    if(statusFilter !== "all"){
        if(statusFilter.startsWith("SBS:")){
            const sbsValue = statusFilter.slice(4);
            filtered = filtered.filter(t => t["TM's Note"] === sbsValue);
        } else {
            filtered = filtered.filter(t => (t["Status"]||"").toLowerCase()===statusFilter);
        }
    }
    filtered = filtered.filter(t => Object.values(t).some(val => String(val).toLowerCase().includes(search)));
    renderTasks(filtered,isRefresh);
}
function updateFavicon(count) {
    const canvas = document.createElement("canvas");
    canvas.width = 64;
    canvas.height = 64;
    const ctx = canvas.getContext("2d");

    // Draw base background (your normal favicon color)
    ctx.fillStyle = "#1a1a1a";
    ctx.fillRect(0, 0, 64, 64);

    // If new tasks â†’ draw red circle + number
    if (count > 0) {
        ctx.fillStyle = "red";
        ctx.beginPath();
        ctx.arc(54, 10, 10, 0, 2 * Math.PI);
        ctx.fill();

        ctx.fillStyle = "white";
        ctx.font = "bold 12px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(count > 99 ? "99+" : count, 54, 10);
    }

    const link = document.querySelector("link[rel='icon']") || document.createElement("link");
    link.rel = "icon";
    link.href = canvas.toDataURL("image/png");
    document.head.appendChild(link);
}

function renderTasks(taskArray,isRefresh=false){
    const taskList = document.getElementById("taskList");
    const totalPages = Math.ceil(taskArray.length/tasksPerPage);
    const start = (currentPage-1)*tasksPerPage;
    const paginated = taskArray.slice(start,start+tasksPerPage);
    if(!isRefresh) taskList.innerHTML="";
    paginated.forEach(t=>{
        const status = (t["Status"]||"").toLowerCase();
        const bcLink = t["BC Link"] || "#";
        const brand = t["Brand"] || "N/A";
        const card = document.createElement("div");
        card.className="task-card";
        card.innerHTML = `
            <div>
                <div class="task-title">${t["Tasks"]||"Untitled"}</div>
                <div class="task-info"><i class="bi bi-briefcase"></i> <span class="label-badge label-brand-text">${brand}</span></div>
                <div class="task-info"><i class="bi bi-list"></i> <span class="label-badge label-task-text">${t["Task"]||"N/A"}</span></div>
                <div class="task-info"><i class="bi bi-check2-square"></i> <span class="label-badge label-subtask-text">${t["Sub-Task"]||"N/A"}</span></div>
                <div class="task-info"><span class="status-badge ${statusClass(status)}">${capitalize(t["Status"]||"N/A")}</span></div>
                <div class="task-info"><i class="bi bi-calendar-event"></i> ${t["Date Assigned"] || "N/A"}</div>
            </div>
            <a href="${bcLink}" target="_blank" class="bc-btn"><i class="bi bi-link-45deg"></i> BC Link</a>
        `;
        card.addEventListener("click", (e)=>{
            if (!e.target.closest(".bc-btn")) showDetail(t);
        });
        taskList.appendChild(card);
    });
    renderPagination(totalPages);
}

function showDetail(task){
    // hide the task grid + pagination
    document.getElementById("taskList").style.display="none";
    document.getElementById("pagination").style.display="none";
    document.getElementById("filterBar").style.display="none";

    const detail = document.getElementById("taskDetail");
    detail.style.display="block";
    detail.innerHTML = `
        <button class="btn btn-sm btn-outline-secondary mb-3" id="backBtn">
            <i class="bi bi-arrow-left"></i> Back to Tasks
        </button>
        <h5 class="mb-3">${task["Tasks"]||"Untitled"}</h5>
        <p><strong>Brand:</strong> ${task["Brand"]||"N/A"}</p>
        <p><strong>Main Task:</strong> ${task["Task"]||"N/A"}</p>
        <p><strong>Sub Task:</strong> ${task["Sub-Task"]||"N/A"}</p>
        <p><strong>Status:</strong> ${task["Status"]||"N/A"}</p>
        <p><strong>Date Assigned:</strong> ${task["Date Assigned"]||"N/A"}</p>
        <p><strong>Agent Assigned:</strong> ${task["Agent Assigned"]||"N/A"}</p>
        <p><strong>TM's Note:</strong> ${task["TM's Note"]||"N/A"}</p>
    `;

    document.getElementById("backBtn").addEventListener("click", ()=>{
        // show the grid back
        document.getElementById("taskList").style.display="grid";
        document.getElementById("pagination").style.display="flex";
        document.getElementById("filterBar").style.display="flex";
        detail.style.display="none";
    });
}
function statusClass(status){
    if(status==="completed") return "status-completed";
    if(status==="ongoing") return "status-ongoing";
    if(status==="cancelled") return "status-cancelled";
    if(status==="assigned") return "status-assigned";
    return "";
}

function renderPagination(totalPages){
    const pagination = document.getElementById("pagination");
    pagination.innerHTML="";
    if(totalPages<=1) return;
    pagination.innerHTML += `<li class="page-item ${currentPage===1?'disabled':''}"><a class="page-link" href="#" data-page="${currentPage-1}">Prev</a></li>`;
    let startPage = Math.max(1,currentPage-2);
    let endPage = Math.min(totalPages,currentPage+2);
    if(currentPage<=3) endPage=Math.min(5,totalPages);
    if(currentPage>=totalPages-2) startPage=Math.max(totalPages-4,1);
    for(let i=startPage;i<=endPage;i++){
        pagination.innerHTML += `<li class="page-item ${i===currentPage?'active':''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
    }
    pagination.innerHTML += `<li class="page-item ${currentPage===totalPages?'disabled':''}"><a class="page-link" href="#" data-page="${currentPage+1}">Next</a></li>`;
    document.querySelectorAll("#pagination .page-link").forEach(link=>{
        link.addEventListener("click",(e)=>{
            e.preventDefault();
            const page=parseInt(link.getAttribute("data-page"));
            if(page>=1 && page<=totalPages){ currentPage=page; filterTasks(); }
        });
    });
}

function updateLastUpdated(){
    const now=new Date();
    document.getElementById("lastUpdated").innerText=`Updated: ${now.toLocaleTimeString()}`;
}

function logout(){ localStorage.removeItem("agent"); location.reload(); }

document.addEventListener("visibilitychange", () => {
    if (!document.hidden) {
        newTaskCount = 0;
        updateFavicon(0);
    }
});

</script>
</body>
</html>
