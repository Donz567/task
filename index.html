<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exclusive Task Manager</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚≠ê</text></svg>">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
body {
    background-color: #f8fafc;
    color: #1a1a1a;
    font-family: 'Segoe UI', Tahoma, sans-serif;
    padding-bottom: 120px;
    transition: background-color 0.3s, color 0.3s;
}

/* --- GLASS EFFECT STYLES --- */
.glass-nav {
    background: rgba(255, 255, 255, 0.75) !important;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.glass-btn {
    background: rgba(33, 37, 41, 0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: transform 0.2s ease, background 0.2s;
    min-width: 120px; 
}
.glass-btn:hover {
    background: rgba(33, 37, 41, 0.95);
    color: #fff;
    transform: scale(1.05);
}
.glass-btn-light {
    background: rgba(255, 255, 255, 0.9);
    color: #0dcaf0;
    border: 1px solid #0dcaf0;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    min-width: 120px; 
}
.glass-btn-light:hover {
    background: #fff;
    color: #0aa2c0;
    transform: scale(1.05);
}

.navbar { background: transparent; }

/* --- FLOATING CONTAINER --- */
.floating-actions {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1040; 
    display: flex;
    flex-direction: column; 
    gap: 12px;
    align-items: flex-end;
}

.status-summary {
    display: flex;
    gap: 0.5rem;
    margin-left: 1rem;
    font-size: 0.85rem;
    flex-wrap: wrap;
}
.status-summary div {
    background: #f1f1f1;
    padding: 4px 10px;
    border-radius: 8px;
    font-weight: 600;
}
.task-card {
    border-radius: 12px;
    padding: 15px;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    background-color: #ffffff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}
.task-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}
.task-card * { position: relative; z-index: 1; }

.task-title {
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 5px;
}
.task-info {
    font-size: 0.85rem;
    margin-bottom: 3px;
}
.status-badge {
    padding: 2px 8px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-block;
}
/* --- WORKING INDICATOR STYLES --- */
.task-working {
  
    box-shadow: 0 4px 15px rgba(13, 110, 253, 0.15) !important;
}
.working-indicator {
    position: absolute;
    top: 12px;
    right: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
    background: #e7f1ff;
    color: #0d6efd;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    z-index: 10;
}
.pulse-dot {
    width: 8px;
    height: 8px;
    background-color: #0d6efd;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(13, 110, 253, 0); }
    100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
}

/* --- STATUS COLORS --- */
.status-completed { background: #bcddc9; color: #1a1a1a; }
.status-ongoing { background: #d9eafd; color: #1a1a1a; }
.status-cancelled { background: #fdd9d9; color: #1a1a1a; }
.status-assigned { background: #f5f5d9; color: #1a1a1a; }
.status-pending { background: #fff3cd; color: #856404; }
.status-wip { background: #e0cffc; color: #2e1065; }

.bc-btn {
    display: block;
    width: 100%;
    text-align: center;
    background: #0e0f0f;
    color: white;
    padding: 5px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    transition: background 0.2s ease;
    margin-top: auto;
}
.bc-btn:hover { background: #35373b; color: white; text-decoration: none; }

#filterBar { display: flex; flex-direction: column; gap: 0.8rem; margin-bottom: 1rem; }
.search-container { width: 100%; display: flex; gap: 0.5rem; }

/* --- FILTER BUTTONS --- */
#statusFilters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}
.filter-btn {
    border: 1px solid #dee2e6;
    background: #fff;
    color: #495057;
    border-radius: 20px;
    padding: 5px 15px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
    font-weight: 500;
}
.filter-btn:hover {
    background: #e9ecef;
}
.filter-btn.active {
    background: #212529;
    color: #fff;
    border-color: #212529;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* --- FILTER STATS TEXT --- */
#filterStats {
    color: #0d6efd;
    font-weight: 600;
    font-size: 0.9rem;
    background: rgba(13, 110, 253, 0.05);
    padding: 5px 10px;
    border-radius: 8px;
    display: inline-block;
    align-self: flex-start;
}

#taskList { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr)); gap: 1rem; }

.label-badge {
    padding: 1px 5px;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-block;
    color: #1a1a1a;
    margin-bottom: 2px;
}
.label-task-text { background-color: #ffd54f; }
.label-subtask-text { background-color: #81c784; }
.label-brand-text { background-color: #64b5f6; }

/* Detail view styling */
#taskDetail {
    display: none;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 20px;
    margin-top: 20px;
    scroll-padding-top: 80px;
}
/* About view styling */
#aboutSection {
    display: none;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 50px 30px;
    margin-top: 20px;
    text-align: center;
}

.daily-reminder {
    position: fixed;
    top: 70px;
    right: 20px;
    z-index: 2000;
    background: #e3f2fd;
    padding: 15px;
    border: 1px solid #90caf9;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    max-width: 320px;
}
.daily-reminder ul {
    margin: 5px 0;
    padding-left: 20px;
    max-height: 150px;
    overflow-y: auto;
    font-size: 0.9rem;
}

.task-bg-icon {
    position: absolute;
    right: 10px;
    bottom: 10px;
    font-size: 140px;
    color: inherit;
    opacity: 0.05;
    pointer-events: none;
    z-index: 0;
}
/* Toggle Switch */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 70px;
    height: 33px;
}
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 36px;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
}
.slider::before {
    position: absolute;
    content: "";
    height: 25px; width: 25px;
    left: 4px; bottom: 4px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.toggle-switch input:checked + .slider {
    background-color: #0d6efd;
    box-shadow: 0 0 10px rgba(13, 110, 253, 0.8);
}
.toggle-switch input:checked + .slider::before { transform: translateX(34px); }

#detailTitle { cursor: pointer; position: relative; }

.detail-header {
    position: sticky;
    top: 70px;
    z-index: 1020;
    background: #fff;
    padding: 10px 0;
}

.feature-icon-box {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    background: #e7f1ff;
    color: #0d6efd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    margin: 0 auto 15px;
}
#templateList{
  cursor: pointer;
}
/* --- CURSOR PARTICLES --- */
#cursorCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none; /* Lets you click through the canvas */
    z-index: 9999; /* Keeps it on top of everything */
}
/* --- DARK MODE OVERRIDES --- */
[data-bs-theme="dark"] body { background-color: #121212; color: #e0e0e0; }
[data-bs-theme="dark"] .glass-nav { background: rgba(33, 37, 41, 0.85) !important; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
[data-bs-theme="dark"] .task-card { background-color: #1e1e1e; border: 1px solid #333; color: #eee; }
[data-bs-theme="dark"] .task-working { box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3) !important; }
[data-bs-theme="dark"] .working-indicator { background: #0d6efd; color: #fff; }
[data-bs-theme="dark"] .status-summary div { background: #2d2d2d; }
[data-bs-theme="dark"] .filter-btn { background: #2d2d2d; color: #ccc; border-color: #444; }
[data-bs-theme="dark"] .filter-btn.active { background: #0d6efd; color: #fff; border-color: #0d6efd; }
[data-bs-theme="dark"] #taskDetail, [data-bs-theme="dark"] #aboutSection, [data-bs-theme="dark"] .detail-header { background: #1e1e1e; color: #eee; }
[data-bs-theme="dark"] .status-completed { background: #198754; color: #fff; }
[data-bs-theme="dark"] .status-ongoing { background: #0d6efd; color: #fff; }
[data-bs-theme="dark"] .status-cancelled { background: #dc3545; color: #fff; }
[data-bs-theme="dark"] .status-assigned { background: #6c757d; color: #fff; }
[data-bs-theme="dark"] .status-pending { background: #ffc107; color: #000; }
[data-bs-theme="dark"] .status-wip { background: #6f42c1; color: #fff; }
[data-bs-theme="dark"] .label-task-text, [data-bs-theme="dark"] .label-subtask-text, [data-bs-theme="dark"] .label-brand-text { color: #000; }
[data-bs-theme="dark"] .task-item { background-color: #2d2d2d !important; color: #eee; border-color: #444 !important; }
</style>
</head>
<body>
<canvas id="cursorCanvas"></canvas>
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 2055" id="toastContainer"></div>

<nav class="navbar navbar-expand-lg sticky-top p-3 glass-nav">
  <div class="container-fluid">
    
    <a class="navbar-brand fw-bold" href="#" onclick="showHome()">üìã Task Manager</a>
    
    <div class="ms-auto d-flex align-items-center gap-2 flex-wrap">
      <div class="status-summary" id="statusSummary"></div>
      
      <div id="loginDropdownContainer"></div>
      <button class="btn btn-outline-danger btn-sm" id="logoutBtn" style="display:none;">Logout</button>
      
      <button class="btn btn-sm btn-outline-secondary" id="darkModeToggle" title="Toggle Dark Mode">
          <i class="bi bi-moon"></i>
      </button>

      <small class="text-muted ms-3" id="lastUpdated"></small>
    </div>
  </div>
</nav>

<div class="container py-4">

<div class="modal fade" id="logsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content rounded-4">
      <div class="modal-header bg-primary text-white rounded-top-4">
        <h5 class="modal-title"><i class="bi bi-journal-text me-2"></i>Daily Work Logs</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-4">
        <div id="logStatsContainer" class="row mb-4 text-center"></div>

        <div id="logsTableContainer" class="table-responsive">
          <p class="text-center text-muted mb-0">No logs recorded yet.</p>
        </div>
      </div>

      <div class="modal-footer d-flex justify-content-between">
        <button class="btn btn-outline-success" id="generateLogBtn">
          <i class="bi bi-file-earmark-excel"></i> Generate Daily Report
        </button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

  <div id="filterBar">
    <div class="search-container">
        <input type="text" id="searchBar" class="form-control" placeholder="Search tasks by name, brand, or status...">
        
        <select id="sortSelect" class="form-select w-auto fw-bold text-secondary">
            <option value="newest">Sort: Newest First</option>
            <option value="oldest">Sort: Oldest First</option>
            <option value="brand">Sort: Brand (A-Z)</option>
            <option value="status">Sort: Status</option>
        </select>
    </div>
    <div id="statusFilters">
        </div>
    <div id="filterStats" class="d-none"></div>
  </div>
  
  <div id="taskList" class="mb-4"></div>
  
  <div id="taskDetail"></div>

  <div id="aboutSection">
      <div class="mb-5">
        <img src="https://cdn-icons-png.flaticon.com/512/906/906334.png" alt="Task Icon" style="width: 80px; margin-bottom: 20px;">
        <h1 class="display-6 fw-bold mb-3">Exclusive Task Manager</h1>
        <p class="text-muted fs-5">Efficiency meets clarity. Your ultimate tool for tracking, logging, and managing daily operations.</p>
        <div class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill mt-2">‚ú® Version 2.2.0</div>
      </div>
      
      <div class="row justify-content-center g-4 text-center">
        <div class="col-md-3">
            <div class="feature-icon-box"><i class="bi bi-arrow-repeat"></i></div>
            <h6 class="fw-bold">Real-time Sync</h6>
            <p class="small text-muted">Tasks update automatically every 30 seconds.</p>
        </div>
        <div class="col-md-3">
            <div class="feature-icon-box"><i class="bi bi-file-earmark-spreadsheet"></i></div>
            <h6 class="fw-bold">Daily Logs</h6>
            <p class="small text-muted">Generate & export CSV reports with one click.</p>
        </div>
        <div class="col-md-3">
            <div class="feature-icon-box"><i class="bi bi-magic"></i></div>
            <h6 class="fw-bold">Smart Templates</h6>
            <p class="small text-muted">Copy/paste standardized task templates instantly.</p>
        </div>
        <div class="col-md-3">
            <div class="feature-icon-box"><i class="bi bi-images"></i></div>
            <h6 class="fw-bold">Image Tools</h6>
            <p class="small text-muted">Integrated Vertx image editor for seamless workflows.</p>
        </div>
      </div>

      <hr class="my-5 opacity-25">

      <div class="text-center">
        <h5 class="fw-bold mb-3">üöÄ Ready to maximize productivity?</h5>
        <button class="btn btn-primary px-4 py-2 rounded-pill shadow-sm" onclick="showHome()">
            <i class="bi bi-arrow-left me-2"></i> Return to Dashboard
        </button>
      </div>
  </div>
  
  <nav>
    <ul class="pagination justify-content-center" id="pagination"></ul>
  </nav>
</div>

<div class="floating-actions">
    <button id="aboutBtn" class="btn glass-btn shadow">
        <i class="bi bi-info-circle"></i> About
    </button>

    <button id="viewLogsBtn" class="btn glass-btn-light shadow">
        <i class="bi bi-journal-text"></i> View Logs
    </button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/1AEFog4va5g5Teg5yiOamSlwwlB4g-UOGT0NUkgz7UBA/gviz/tq?tqx=out:json";

let tasks = [];
let agents = new Set();
let sbsSet = new Set();
let currentPage = 1;
let lastTaskCount = 0;  
let newTaskCount = 0;     
let lastScrollPosition = 0; 

// Filter & Sort State
let selectedStatuses = new Set(['all']);
let currentSort = "newest";

const tasksPerPage = 20;
const agentMap = {
    "Adriana, Venz": "Venz",
    "Marisa, Venz": "Venz",
    "Venz, Adriana": "Venz",
    "Adriana, Marisa": "Marisa",
    "Marisa, Adriana": "Marisa",
    "Marisa, Marissa C": "Marisa",
    "Marisa, Venz": "Marisa",
    "Adriana, Peter": "Peter",
    "Peter, Jonathan": "Peter",
    "Adriana, Ezequel": "Ezequel",
    "Raven, Andrew": "Raven",
    "Adriana, Sedney": "Sedney",
    "Adriana, Jhonmar": "Jhonmar",
    "Adriana, Jade": "Jade",
};

document.addEventListener("DOMContentLoaded", () => {
    initApp();
    initDarkMode();
    
    document.getElementById("searchBar").addEventListener("input", () => { currentPage = 1; filterTasks(); });
    document.getElementById("logoutBtn").addEventListener("click", logout);
    document.getElementById("aboutBtn").addEventListener("click", showAbout);
    
    // Sort Dropdown Listener
    document.getElementById("sortSelect").addEventListener("change", (e) => {
        currentSort = e.target.value;
        currentPage = 1;
        filterTasks();
    });

    setInterval(() => { fetchTasks().then(() => filterTasks(true)); }, 30000);
});

// --- DARK MODE LOGIC ---
function initDarkMode() {
    const darkModeBtn = document.getElementById("darkModeToggle");
    const savedTheme = localStorage.getItem("theme") || "light";
    
    function applyTheme(isDark) {
        document.documentElement.setAttribute('data-bs-theme', isDark ? 'dark' : 'light');
        darkModeBtn.innerHTML = isDark ? '<i class="bi bi-sun"></i>' : '<i class="bi bi-moon"></i>';
        localStorage.setItem("theme", isDark ? "dark" : "light");
    }
    
    applyTheme(savedTheme === "dark");

    darkModeBtn.addEventListener("click", () => {
        const isCurrentlyDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        applyTheme(!isCurrentlyDark);
    });
}

function showAbout() {
    document.getElementById("taskList").style.display = "none";
    document.getElementById("pagination").style.display = "none";
    document.getElementById("filterBar").style.display = "none";
    document.getElementById("taskDetail").style.display = "none";
    document.getElementById("aboutSection").style.display = "block";
    window.scrollTo(0, 0); 
}

function showHome() {
    document.getElementById("taskList").style.display = "grid";
    document.getElementById("pagination").style.display = "flex";
    document.getElementById("filterBar").style.display = "flex";
    document.getElementById("taskDetail").style.display = "none";
    document.getElementById("aboutSection").style.display = "none";
}

async function initApp() {
    await fetchTasks();
    setupLogin();
    setupStatusFilters();
    filterTasks();
    requestNotificationPermission();
    setTimeout(notifyDailyOngoingTasks, 2000); 
}

function normalizeBrandName(brand) {
  if (!brand) return brand;
  const b = brand.trim().toLowerCase();
  if (b === "carolina/double h boots") return "Carolina/Double H";
  if (b === "vertx_2p") return "Vertx";
  if (b === "evenflo - 2p") return "Evenflo";
  if (b === "tru-spec-2p") return "TRUE-SPEC";
  if (b === "wonderfold-2p") return "Wonderfold";
  if (b === "Cybex (3P)") return "Cybex";
  if (b === "WONDERFOLD-3P") return "WONDERFOLD";
  return brand;
}

function requestNotificationPermission() {
  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission();
  }
}

function getOngoingTasks() {
  const loginName = localStorage.getItem("agent");
  if (!loginName) return [];
  return tasks.filter(t => t["Agent Assigned"] === loginName && 
                          (t["Status"]||"").toLowerCase() === "ongoing");
}

function notifyDailyOngoingTasks() {
  const ongoing = getOngoingTasks();
  if (ongoing.length === 0) return;

  const today = new Date().toDateString();
  if (localStorage.getItem("lastOngoingNotify") === today) return;

  const listHtml = ongoing.map(t => {
    let linkHtml = t["BC Link"] 
      ? `<a href="${t["BC Link"]}" target="_blank">(BC)</a>` 
      : "";
    return `<li>${t["Tasks"]} ${linkHtml}</li>`;
  }).join("");

  if ("Notification" in window && Notification.permission === "granted") {
    const message = ongoing.map(t => `- ${t["Tasks"]}`).join("\n");
    new Notification("Ongoing Tasks Reminder", {
      body: message,
      icon: "https://cdn-icons-png.flaticon.com/512/4436/4436481.png"
    });
  }

  const container = document.createElement("div");
  container.className = "daily-reminder";
  container.innerHTML = `
    <strong>üîî Daily Reminder</strong>
    <div>You have <b>${ongoing.length}</b> ongoing tasks:</div>
    <ul>${listHtml}</ul>
    <button class="btn btn-sm btn-outline-secondary mt-2">Dismiss</button>
  `;
  document.body.appendChild(container);
  container.querySelector("button").onclick = () => container.remove();

  localStorage.setItem("lastOngoingNotify", today);
}

function parseSheetDate(value) {
    if (!value) return null;
    const match = value.match(/Date\((\d+),(\d+),(\d+)\)/);
    if (match) {
        const year = parseInt(match[1]);
        const month = parseInt(match[2]); 
        const day = parseInt(match[3]);
        return new Date(year, month, day);
    }
    if (!isNaN(value)) {
        const epoch = new Date(1899, 11, 30);
        return new Date(epoch.getTime() + Number(value) * 24 * 60 * 60 * 1000);
    }
    const date = new Date(value);
    if (!isNaN(date)) return date;
    return null; 
}

function formatDate(date) {
    if (!date) return "N/A";
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2,'0'); 
    const d = String(date.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
}

async function fetchTasks() {
    try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        tasks = json.table.rows.flatMap((row, i) => {
        let obj = {};
        json.table.cols.forEach((col, j) => { 
            obj[col.label] = row.c[j] ? row.c[j].v : ""; 
        });
        obj["Brand"] = normalizeBrandName(obj["Brand"]);
        obj["_id"] = i;
        obj._dateParsed = parseSheetDate(obj["Date Assigned"]);
        
        const agentsAssigned = (obj["Agent Assigned"] || "")
            .split(",")                  
            .map(a => a.trim())          
            .map(a => agentMap[a] || a) 
            .filter(a => a);             

        return agentsAssigned.map(agent => {
            const copy = {...obj};
            copy["Agent Assigned"] = agent;
            if(agent) agents.add(agent);         
            if(obj["TM's Note"]) sbsSet.add(obj["TM's Note"]); 
            return copy;
        });
    });

        tasks.sort((a,b) => b._id - a._id); 

        const loginName = localStorage.getItem("agent");
        if (loginName) {
            const currentCount = tasks.filter(t => t["Agent Assigned"] === loginName).length;
            if (lastTaskCount > 0 && currentCount > lastTaskCount) {
                newTaskCount += (currentCount - lastTaskCount);
                updateFavicon(newTaskCount);
            }
            lastTaskCount = currentCount;
        }

        updateLastUpdated();
        updateStatusSummary();
    } catch(err) { console.error("Error fetching tasks:", err); }
}

function setupLogin() {
    const loginName = localStorage.getItem("agent");
    if(loginName){
        document.getElementById("logoutBtn").style.display="inline-block";
        document.getElementById("loginDropdownContainer").innerHTML = `<span class="fw-bold text-primary">${loginName}</span>`;
    } else {
        let normalizedAgents = new Set();
        agents.forEach(agent => {
            if(agentMap[agent]) normalizedAgents.add(agentMap[agent]);
            else normalizedAgents.add(agent);
        });

        let dropdownHTML = `<select class="form-select form-select-sm" id="loginDropdown"><option selected disabled>Login as...</option>`;
        normalizedAgents.forEach(agent => { dropdownHTML += `<option value="${agent}">${agent}</option>`; });
        dropdownHTML += `</select>`;
        document.getElementById("loginDropdownContainer").innerHTML = dropdownHTML;

        document.getElementById("loginDropdown").addEventListener("change", (e) => {
            localStorage.setItem("agent", e.target.value);
            location.reload();
        });
    }
}

function setupStatusFilters(){
    const container = document.getElementById("statusFilters");
    const options = [
        { id: "all", label: "All Status" },
        { id: "ongoing", label: "Ongoing" },
        { id: "pending", label: "Pending" },
        { id: "completed", label: "Completed" },
        { id: "cancelled", label: "Cancelled" },
        { id: "assigned", label: "Assigned" },
        { id: "wip", label: "WIP" }
    ];

    container.innerHTML = options.map(opt => `
        <div class="filter-btn ${opt.id === 'all' ? 'active' : ''}" 
             data-value="${opt.id}" 
             onclick="toggleFilter('${opt.id}')">
             ${opt.label}
        </div>
    `).join("");
}

function toggleFilter(val) {
    if (val === 'all') {
        selectedStatuses.clear();
        selectedStatuses.add('all');
    } else {
        selectedStatuses.delete('all');
        if (selectedStatuses.has(val)) {
            selectedStatuses.delete(val);
        } else {
            selectedStatuses.add(val);
        }
        
        if (selectedStatuses.size === 0) {
            selectedStatuses.add('all');
        }
    }
    
    updateFilterUI();
    currentPage = 1; 
    filterTasks();
}

function updateFilterUI() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        const val = btn.getAttribute('data-value');
        if (selectedStatuses.has(val)) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

function filterTasks(isRefresh=false){
    const loginName = localStorage.getItem("agent");
    if(!loginName) return;

    fetchTasks().then(() => { 
        const search = document.getElementById("searchBar").value.toLowerCase();
        
        let filtered = tasks.filter(t => t["Agent Assigned"]===loginName);
        
        if (!selectedStatuses.has('all')) {
            filtered = filtered.filter(t => {
                const s = (t["Status"]||"").toLowerCase();
                return selectedStatuses.has(s);
            });
        }
        
        filtered = filtered.filter(t => Object.values(t).some(val => String(val).toLowerCase().includes(search)));
        
        // --- NEW: APPLY SORTING ---
        if (currentSort === "newest") {
            filtered.sort((a,b) => b._id - a._id);
        } else if (currentSort === "oldest") {
            filtered.sort((a,b) => a._id - b._id);
        } else if (currentSort === "brand") {
            filtered.sort((a,b) => (a["Brand"]||"").localeCompare(b["Brand"]||""));
        } else if (currentSort === "status") {
            filtered.sort((a,b) => (a["Status"]||"").localeCompare(b["Status"]||""));
        }
        
        updateFilterStats(filtered);
        renderTasks(filtered, isRefresh);
        updateStatusSummary(); 
    });
}

function updateFilterStats(filteredTasks) {
    const statsEl = document.getElementById("filterStats");
    if (selectedStatuses.has('all')) {
        statsEl.innerHTML = `Showing: All Tasks (${filteredTasks.length})`;
        statsEl.classList.remove("d-none");
        return;
    }

    const counts = {};
    filteredTasks.forEach(t => {
        const s = (t["Status"] || "").toLowerCase();
        counts[s] = (counts[s] || 0) + 1;
    });

    const parts = [];
    selectedStatuses.forEach(status => {
        const count = counts[status] || 0;
        const label = status.charAt(0).toUpperCase() + status.slice(1);
        parts.push(`${label} - ${count}`);
    });

    if (parts.length > 0) {
        statsEl.innerHTML = "Showing: " + parts.join(" / ");
        statsEl.classList.remove("d-none");
    } else {
        statsEl.classList.add("d-none");
    }
}

function updateStatusSummary() {
    const summaryEl = document.getElementById("statusSummary");
    const loginName = localStorage.getItem("agent");
    if(!loginName) return;

    const data = tasks.filter(t => t["Agent Assigned"] === loginName);
    const counts = { ongoing:0, completed:0, cancelled:0, assigned:0, pending:0, wip:0 };
    
    data.forEach(t => {
        let s = (t["Status"]||"").toLowerCase();
        if(counts[s] !== undefined) counts[s]++;
    });

    summaryEl.innerHTML = `
        <div class="status-badge status-assigned">Total: ${data.length}</div>
        <div class="status-badge status-ongoing">Ongoing: ${counts.ongoing}</div>
        <div class="status-badge status-pending">Pending: ${counts.pending}</div>
        <div class="status-badge status-wip">WIP: ${counts.wip}</div>
        <div class="status-badge status-completed">Completed: ${counts.completed}</div>
        <div class="status-badge status-cancelled">Cancelled: ${counts.cancelled}</div>
        <div class="status-badge status-assigned">Assigned: ${counts.assigned}</div>
    `;
}

function updateFavicon(count) {
  const canvas = document.createElement("canvas");
  canvas.width = 64;
  canvas.height = 64;
  const ctx = canvas.getContext("2d");

  ctx.font = "54px Segoe UI Emoji";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("‚≠ê", 26, 38); 

  if (count > 0) {
    ctx.beginPath();
    ctx.arc(46, 18, 22, 0, 2 * Math.PI); 
    ctx.fillStyle = "#ff0000"; 
    ctx.fill();
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#ffffff"; 
    ctx.stroke();

    ctx.fillStyle = "white";
    ctx.font = "bold 28px Arial"; 
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(count > 99 ? "99+" : count, 46, 19); 
  }

  const link = document.querySelector("link[rel='icon']") || document.createElement("link");
  link.rel = "icon";
  link.href = canvas.toDataURL("image/png");
  document.head.appendChild(link);
}

function renderTasks(taskArray){
    const taskList = document.getElementById("taskList");
    taskList.innerHTML = ""; 

    const totalPages = Math.ceil(taskArray.length/tasksPerPage);
    const start = (currentPage-1)*tasksPerPage;
    const paginated = taskArray.slice(start,start+tasksPerPage);

    const todayStr = new Date().toISOString().split("T")[0];
    const logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");

    paginated.forEach(t => {
        const status = (t["Status"]||"").toLowerCase();
        const bcLink = t["BC Link"] || "#";
        const brand = normalizeBrandName(t["Brand"]) || "N/A";
        
        const checkBrand = normalizeBrandName(t["Brand"] || "nobrand").toLowerCase();
        const checkTitle = t["Tasks"] || "Untitled";
        const isWorking = logs.some(l => l.date === todayStr && l.task === checkTitle && l.brand === checkBrand);

        const card = document.createElement("div");
        card.className = `task-card ${isWorking ? 'task-working' : ''}`;
        
        let badgeClass = "status-" + status;
        
        card.innerHTML = `
                ${isWorking ? `<div class="working-indicator"><div class="pulse-dot"></div> Logged</div>` : ''}
                
                <div class="task-title">${t["Tasks"]||"Untitled"}</div>

                <div class="task-info">
                    <i class="bi bi-tags text-primary"></i>
                    <span class="label-badge label-brand-text">${brand}</span>
                  </div>

                  <div class="task-info">
                    <i class="bi bi-list-task text-warning"></i>
                    <span class="label-badge label-task-text">${t["Task"]||"N/A"}</span>
                  </div>

                  <div class="task-info">
                    <i class="bi bi-check2-square text-success"></i>
                    <span class="label-badge label-subtask-text">${t["Sub-Task"]||"N/A"}</span>
                  </div>
                  <div class="task-info">
                      <i class="bi bi-flag text-info"></i>
                      <span class="status-badge ${badgeClass}">
                        ${t["Status"] || "N/A"}
                      </span>
                    </div>

                  <div class="task-info">
                    <i class="bi bi-calendar-event text-primary"></i>
                    ${formatDate(t._dateParsed) || "N/A"}
                  </div>
                </div>

                <a href="${bcLink}" target="_blank" class="bc-btn">
                  <i class="bi bi-link-45deg"></i> BC Link
                </a>

            ${getBackgroundIcon(status)}
        `;
        card.addEventListener("click", (e)=>{
            if (!e.target.closest(".bc-btn")) showDetail(t);
        });
        taskList.appendChild(card);
    });

    renderPagination(totalPages);
}

function getBackgroundIcon(status) {
  switch(status) {
    case "ongoing": 
      return `<i class="bi bi-hourglass-split task-bg-icon text-primary"></i>`;
    case "pending": 
      return `<i class="bi bi-hourglass task-bg-icon text-warning"></i>`;
    case "wip": 
      return `<i class="bi bi-cone-striped task-bg-icon text-warning"></i>`;
    case "completed": 
      return `<i class="bi bi-check2-circle task-bg-icon text-success"></i>`;
    case "cancelled": 
      return `<i class="bi bi-slash-circle task-bg-icon text-danger"></i>`;
    case "assigned": 
      return `<i class="bi bi-person-workspace task-bg-icon text-warning"></i>`;
    default: 
      return ``;
  }
}

function showDetail(task) {
    lastScrollPosition = window.scrollY;

    const taskListEl = document.getElementById("taskList");
    const paginationEl = document.getElementById("pagination");
    const filterBarEl = document.getElementById("filterBar");
    const detailEl = document.getElementById("taskDetail");
    const aboutEl = document.getElementById("aboutSection");

    taskListEl.style.display = "none";
    paginationEl.style.display = "none";
    filterBarEl.style.display = "none";
    aboutEl.style.display = "none";
    detailEl.style.display = "block";

    window.scrollTo({ top: 0, behavior: 'smooth' });

    const cardTitle = task["Tasks"] || "Untitled";
    const brand = normalizeBrandName(task["Brand"] || "nobrand").toLowerCase();
    
    const status = (task["Status"] || "N/A").toLowerCase();
    const dateAssigned = formatDate(task._dateParsed);
    const sbsNote = task["TM's Note"] || "";
    const bcLink = task["BC Link"] || "#";
    
    function statusClass(s) {
        if (s === "completed") return "status-completed";
        if (s === "ongoing") return "status-ongoing";
        if (s === "pending") return "status-pending";
        if (s === "cancelled") return "status-cancelled";
        if (s === "wip") return "status-wip";
        if (s === "assigned") return "status-assigned";
        return "badge bg-secondary";
    }

    const categories = { 
        "Validation": [ "[brand]-validating-data for new supplier", "[brand]-validating-upc list source" ], 
        "Analysis": [ "[brand]-analyzing-task prioritization", "[brand]-analyzing-new supplier source", "[brand]-analyzing-existing supplier source", "[brand]-analyzing-bulk order source", "[brand]-analyzing-prebook order source", "[brand]-analyzing-inventory for deletion", "[brand]-analyzing-listing loader request", "[brand]-analyzing-shopify source", "analyzing-manage experiment", "[brand]-analyzing-shopkeep source" ], 
        "Gathering Data": [ "[brand]-gathering-new supplier data", "[brand]-gathering-existing supplier data", "[brand]-gathering-bulk/preebook data", "[brand]-gathering-enhancement data", "[brand]-gathering-flat file data", "[brand]-gathering-pre existing asins", "[brand]-gathering-skus for deletion", "[brand]-gathering-brand store data", "[brand]-gathering-shopify data", "[brand]-gathering-shopkeep data", "[brand]-gathering-skus for deletion", "[brand]-gathering-SIPV", "[brand]-gathering-manage experiment", "all brands-gathering-voice of the customer", "all brands-gathering-suppressed listings", "all brands-gathering-stranded listings", "all brands-gathering-standalone listings" ], 
        "Creation": [ "[brand]-creating-new supplier masterlist", "[brand]-creating-existing supplier masterlist", "[brand]-creating- bulk/prebook masterlist", "[brand]-creating-new supplier listing loader file", "[brand]-creating-existing supplier listing loader file", "[brand]-creating-bulk/prebook listing loader file", "[brand]-creating-new supplier ilf", "[brand]-creating-existing supplier ilf", "[brand]-creating-bulk/prebook ilf", "[brand]-creating-new supplier cost sheet", "[brand]-creating-new supplier sku upc list", "[brand]-creating-existing supplier cost sheet", "[brand]-creating-existing supplier sku upc list", "[brand]-creating-bulk/prebook cost sheet", "[brand]-creating-bulk/prebook sku upc list", "[brand]-creating-existing supplier advertising campaign list", "[brand]-creating-flat file enhancement", "[brand]-creating-flat file listing concern", "creating-manage experiment", "[brand]-creating-ebc enhancement" ], 
        "Verification / Image Update": [ "[brand]-verifying-upc match manual", "[brand]-verifying-data central result", "[brand]-verifying-listing loader request", "[brand]-verifying-image urls", "[brand]-enhancing-images for enhancement", "[brand]-updating-sas flat file", "[brand]-updating-listing in amazon", "[brand]-updating-edit page manually enhancement" ], 
        "Review / Upload": [ "[brand]-reviewing-all files", "[brand]-reviewing-newly uploaded listings","[brand]-reviewing-newly uploaded listings enhancement", "[brand]-uploading-ilf", "[brand]-uploading-flat file", "[brand]-uploading-shipping plan", "[brand]-uploading-weights and dimensions", "[brand]-uploading-video", "[brand]-uploading-images", "[brand]-attaching-files in bc", "[brand]-reviewing-all files enhancement", "[brand]-attaching-files in bc enhancement", "[brand]-uploading-flat file enhancement", "[brand]-uploading-video enhancement" ], 
        "Investigation / Fixing / Correction": [ "[brand]-investigating-listing issue", "[brand]-fixing-suppressed/quality alerts", "[brand]-fixing-stranded inventory", "[brand]-fixing-standalone", "[brand]-correcting-masterlist file", "[brand]-correcting-ilf", "[brand]-correcting-cost sheet", "[brand]-correcting-sku-upc list", "[brand]-correcting-flatfile error", "[brand]-investigating-pesticide marking", "[brand]-fixing-listing issue", "[brand]-investigating-listing enhancement", "[brand]-correcting-flatfile error enhancement", "[brand]-investigating-SIP", "[brand]-investigating-policy warning", "[brand]-investigating-inaccurate condition complaint" ], 
        "Update / Send & Monitor Case": [ "[brand]-updating-trackers", "[brand]-updating-ebc", "[brand]-updating-search terms", "[brand]-sending-amazon case", "[brand]-sending-sas email", "[brand]-checking-amazon case & ff ups", "[brand]-checking-sas response", "[brand]-sending-sas ops", "[brand]-sending-amazon case enhancement", "[brand]-checking-amazon case & ff ups enhancement", "[brand]-updating-ebc enhancement", "[brand]-updating-search terms enhancement", "[brand]-sending-appeal" ], 
        "Monitoring": [ "none-checking-skype concerns", "none-checking-email concerns", "none-checking-basecamp notifications", "none-prioritizing tasks", "none-addressing-concerns-via skype", "none-addressing-concerns-via email", "none-addressing-concerns-via basecamp", "[brand]-logging-in 2P account", "[brand]-logging-in 1P account" ], 
        "Admin": [ "admin-break", "admin-training:[task]-{person}", "admin-feedbacking-[name of person/group]", "admin-assisting-[task] [name of person/group]", "admin-meeting-{name of person/group}", "admin-coaching-{name of person/group}", "sbs-certifying-[task name]-[name of agent]", "admin-observing:[task]-[name of person]", "admin-meeting-team-listing ex", "admin-1on1-[name]", "[brand]-creating-flat file", "[brand]-updating-listing in amazon (manual)", "[brand]-creating-listing in amazon (manual)", "[brand]-creating-deletion file", "[brand]-gathering-images for EBC", "[brand]-creating-ebc enhancement", "[brand]-updating-ebc enhancement", "[brand]-certify-" ] 
    };

    let rendered = "";
    for (const [header, items] of Object.entries(categories)) {
        const processed = items.map(t => {
            const lower = t.toLowerCase();
            if (lower.startsWith("admin") || lower.startsWith("none")) return t;
            if (t.includes("[brand]")) {
                return t.replace(/\[brand\]/g, brand) + ` (${cardTitle})`;
            }
            return t;
        });

        rendered += `
        <h6 class="mt-3 mb-2 fw-bold text-primary">${header}</h6>
        <div class="row">
            ${processed.map(item => `
                <div class="col-md-6 mb-2">
                    <div class="task-item d-flex align-items-center border rounded px-2 py-1 small bg-light text-truncate" title="Click to copy">
                        <span class="flex-grow-1 me-2">${item}</span>
                    </div>
                </div>
            `).join("")}
        </div>
        `;
    }

    detailEl.innerHTML = `
    <div class="detail-header d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-3">
          <button class="btn btn-sm btn-outline-secondary" id="backBtn">
            <i class="bi bi-arrow-left"></i> Back to Tasks
          </button>
          <label class="toggle-switch">
            <input type="checkbox" id="logToggle" onchange="toggleLog(this)">
            <span class="slider"></span>
          </label>
          <span class="fw-bold text-secondary">Working?</span>
        </div>

        ${
          normalizeBrandName(task["Brand"]).toLowerCase() === "vertx"
            ? `<div class="d-flex align-items-center gap-2">
                 <span class="fw-bold text-secondary">Tool:</span>
                 <a href="https://donz567.github.io/whiteeditor/" target="_blank" 
                    class="btn btn-outline-primary rounded-pill px-2 py-1">Image Editor</a>
               </div>`
            : ""
        }
    </div>
    
    <h5 class="mb-2" id="detailTitle">${cardTitle}</h5>
    <div class="mb-3 d-flex flex-wrap gap-1 align-items-center" style="font-size: 0.8rem;">
        <span class="badge bg-primary" id="detailBrand">${brand}</span>
        <span class="badge bg-success label-subtask-text">${task["Sub-Task"] || "N/A"}</span>
        <span class="badge ${statusClass(status)}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
        ${sbsNote ? `<span class="badge bg-warning text-dark">${sbsNote}</span>` : ""}
        <span class="text-muted">üìÖ ${dateAssigned}</span>
        ${bcLink !== "#" ? `<a href="${bcLink}" target="_blank" class="text-decoration-none">üîó BC Link</a>` : ""}
    </div>

    <div class="d-flex flex-wrap gap-2 mb-2" id="bubbleContainer"></div>

    <input type="text" class="form-control form-control-sm mb-3" id="templateSearch" autocomplete="off" placeholder="Type to search... (Auto-saves after 2 seconds)">
    
    <div id="templateList">${rendered}</div>
    `;

    const searchInput = document.getElementById("templateSearch");
    let debounceTimer; 
    
    function refreshBubbles() {
        let recentSearches = JSON.parse(localStorage.getItem("recentSearches") || "[]");
        
        recentSearches = recentSearches.filter((item, index, self) =>
            index === self.findIndex((t) => (t.toLowerCase() === item.toLowerCase()))
        );

        if (recentSearches.length > 15) {
            recentSearches = recentSearches.slice(0, 15);
            localStorage.setItem("recentSearches", JSON.stringify(recentSearches));
        }

        if (recentSearches.length === 0) {
            recentSearches = ["Validating", "Analyzing", "Gathering", "Creation", "Admin"];
        }

        const bubblesHtml = recentSearches.map(term => 
            `<button type="button" class="btn btn-sm btn-outline-primary rounded-pill search-bubble mb-1" style="font-size: 0.75rem;">${term}</button>`
        ).join(" ");

        const container = document.getElementById("bubbleContainer");
        container.innerHTML = bubblesHtml;

        container.querySelectorAll(".search-bubble").forEach(btn => {
            btn.addEventListener("click", () => {
                const val = btn.textContent;
                searchInput.value = val;
                performSearch(val);
            });
        });
    }

    function performSearch(term) {
        const lowerTerm = term.toLowerCase();
        document.querySelectorAll("#templateList h6").forEach(header => {
            const section = header.nextElementSibling;
            let anyVisible = false;
            section.querySelectorAll(".col-md-6").forEach(div => {
                const match = div.innerText.toLowerCase().includes(lowerTerm);
                div.style.display = match ? "" : "none";
                if (match) anyVisible = true;
            });
            header.style.display = anyVisible ? "" : "none";
            section.style.display = anyVisible ? "" : "none";
        });
    }

    searchInput.addEventListener("input", (e) => {
        const val = e.target.value;
        
        performSearch(val);

        clearTimeout(debounceTimer);

        debounceTimer = setTimeout(() => {
            const trimmedVal = val.trim();
            if (trimmedVal.length > 2) {
                let history = JSON.parse(localStorage.getItem("recentSearches") || "[]");
                history = history.filter(h => h.toLowerCase() !== trimmedVal.toLowerCase());
                history.unshift(trimmedVal);
                
                if (history.length > 15) history = history.slice(0, 15);
                
                localStorage.setItem("recentSearches", JSON.stringify(history));
                
                refreshBubbles();
            }
        }, 2000); 
    });

    refreshBubbles();

    const titleEl = detailEl.querySelector("#detailTitle");
    titleEl.addEventListener("click", () => {
        navigator.clipboard.writeText(titleEl.textContent.trim()).then(() => showCopied(titleEl));
    });

    detailEl.querySelectorAll(".task-item").forEach(item => {
        item.addEventListener("click", e => {
            e.stopPropagation();
            navigator.clipboard.writeText(item.querySelector("span").innerText).then(() => showCopied(item));
        });
    });

    function showCopied(element) {
        const old = element.querySelector(".copied-indicator");
        if (old) old.remove();
        const indicator = document.createElement("span");
        indicator.className = "copied-indicator";
        indicator.innerText = "‚úÖ Copied!";
        indicator.style.marginLeft = "8px"; 
        indicator.style.color = "#28a745";
        element.appendChild(indicator);
        setTimeout(() => indicator.remove(), 1000);
    }

    document.getElementById("backBtn").addEventListener("click", () => {
        taskListEl.style.display = "grid";
        paginationEl.style.display = "flex";
        filterBarEl.style.display = "flex";
        detailEl.style.display = "none";
        aboutEl.style.display = "none";
        filterTasks();
        window.scrollTo({ top: lastScrollPosition, behavior: 'auto' });
    });

    checkLogToggle();
}

function toggleLog(toggleEl) {
  const taskTitle = document.getElementById("detailTitle")?.textContent?.trim() || "Unknown Task";
  const brand = document.getElementById("detailBrand")?.textContent?.trim() || "Unknown Brand";
  const subTask = document
  .querySelector("#taskDetail .label-subtask-text")
  ?.textContent?.trim() || "N/A";

  const now = new Date();
  const dateStr = now.toISOString().split("T")[0];

  let logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");

  if (toggleEl.checked) {
    const already = logs.some(l => l.date === dateStr && l.task === taskTitle && l.brand === brand);
    if (!already) {
      logs.push({
        date: dateStr,
        task: taskTitle,
        brand: brand,
        subtask: subTask,
        timestamp: now.toISOString(),
      });
      localStorage.setItem("taskLogs", JSON.stringify(logs));
      showBanner(`Logged "${taskTitle}"`, "info");
    }
  } else {
    logs = logs.filter(l => !(l.date === dateStr && l.task === taskTitle && l.brand === brand));
    localStorage.setItem("taskLogs", JSON.stringify(logs));
    showBanner(`Removed "${taskTitle}"`, "secondary");
  }
}

function checkLogToggle() {
  const toggle = document.getElementById("logToggle");
  if (!toggle) return;

  const taskTitle = document.getElementById("detailTitle")?.textContent?.trim() || "";
  const brand = document.getElementById("detailBrand")?.textContent?.trim() || "";

  const now = new Date();
  const dateStr = now.toISOString().split("T")[0];

  const logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");
  const already = logs.some(l => l.date === dateStr && l.task === taskTitle && l.brand === brand);

  toggle.checked = already;
  const label = document.querySelector('.fw-bold.text-secondary');
  
  if (toggle.checked) {
    label.style.color = '#0d6efd';
    label.style.textShadow = '0 0 8px rgba(13,110,253,0.6)';
  } else {
    label.style.color = '#6c757d';
    label.style.textShadow = 'none';
  }
  toggle.disabled = false; 
}

(function cleanOldLogs() {
  const now = new Date();
  const hour = now.getHours();
  
  if (hour >= 13) {
    let logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");
    const today = new Date();
    const todayStr = today.toISOString().split("T")[0];
    
    logs = logs.filter(l => l.date === todayStr);
    localStorage.setItem("taskLogs", JSON.stringify(logs));
  }
})();

document.getElementById("viewLogsBtn")?.addEventListener("click", showLogs);

function showLogs() {
  const logsTableContainer = document.getElementById("logsTableContainer");
  const logStatsContainer = document.getElementById("logStatsContainer");
  const logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");

  if (!Array.isArray(logs) || logs.length === 0) {
    logStatsContainer.innerHTML = "";
    logsTableContainer.innerHTML = `<p class="text-center text-muted mb-0">No logs recorded yet.</p>`;
    return;
  }

  // --- NEW: LOG STATISTICS DASHBOARD ---
  let totalLogs = logs.length;
  let completedLogs = logs.filter(l => l.status === "Completed").length;
  let ongoingLogs = logs.filter(l => l.status === "Ongoing").length;
  
  let brandCounts = {};
  let topBrand = "N/A", topCount = 0;
  logs.forEach(l => {
      if(l.brand) {
          brandCounts[l.brand] = (brandCounts[l.brand] || 0) + 1;
          if(brandCounts[l.brand] > topCount) {
              topCount = brandCounts[l.brand];
              topBrand = l.brand;
          }
      }
  });

  logStatsContainer.innerHTML = `
      <div class="col-md-3 mb-2">
          <div class="p-2 bg-primary bg-opacity-10 border border-primary border-opacity-25 rounded shadow-sm">
              <h5 class="text-primary mb-0 fw-bold">${totalLogs}</h5>
              <span class="text-muted fw-bold" style="font-size: 0.75rem;">Total Logged</span>
          </div>
      </div>
      <div class="col-md-3 mb-2">
          <div class="p-2 bg-success bg-opacity-10 border border-success border-opacity-25 rounded shadow-sm">
              <h5 class="text-success mb-0 fw-bold">${completedLogs}</h5>
              <span class="text-muted fw-bold" style="font-size: 0.75rem;">Completed</span>
          </div>
      </div>
      <div class="col-md-3 mb-2">
          <div class="p-2 bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded shadow-sm">
              <h5 class="text-warning mb-0 fw-bold">${ongoingLogs}</h5>
              <span class="text-muted fw-bold" style="font-size: 0.75rem;">Ongoing</span>
          </div>
      </div>
      <div class="col-md-3 mb-2">
          <div class="p-2 bg-info bg-opacity-10 border border-info border-opacity-25 rounded shadow-sm">
              <h5 class="text-info mb-0 fw-bold text-truncate" title="${topBrand}">${topBrand}</h5>
              <span class="text-muted fw-bold" style="font-size: 0.75rem;">Top Brand</span>
          </div>
      </div>
  `;
  // -------------------------------------

  let html = `
    <table class="table table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Date</th>
          <th>Brand</th>
          <th>Task Category</th> <th>Task Name</th> <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
  `;

  logs.forEach((log, index) => {
    const currentStatus = log.status || "";
    const isCustom =
      currentStatus &&
      !["Completed", "Ongoing"].includes(currentStatus);

    html += `
      <tr>
        <td>${log.date || "N/A"}</td>
        <td><span class="badge bg-secondary">${log.brand || "N/A"}</span></td>
        <td>${log.subtask || "N/A"}</td>
        <td>${log.task || "N/A"}</td>
        <td><span class="badge ${currentStatus === 'Completed' ? 'bg-success' : currentStatus === 'Ongoing' ? 'bg-warning text-dark' : 'bg-info'}">${log.status || "N/A"}</span></td>
        <td>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <button type="button" class="btn btn-sm btn-success" onclick="updateLogStatus(${index}, 'Completed')">Completed</button>
            <button type="button" class="btn btn-sm btn-warning" onclick="updateLogStatus(${index}, 'Ongoing')">Ongoing</button>
            <div class="d-flex align-items-center flex-grow-1">
              <input 
                type="text" 
                class="form-control form-control-sm me-2" 
                id="customInput-${index}" 
                placeholder="Custom status..."
                value="${isCustom ? currentStatus : ''}"
                oninput="toggleSubmitButton(${index})"
              >
              <button 
                id="submitBtn-${index}" 
                class="btn btn-sm btn-primary" 
                style="display:${isCustom ? 'inline-block' : 'none'}"
                onclick="submitCustomStatus(${index})"
              >
                Submit
              </button>
            </div>
          </div>
        </td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  logsTableContainer.innerHTML = html;
}

function toggleSubmitButton(index) {
  const input = document.getElementById(`customInput-${index}`);
  const btn = document.getElementById(`submitBtn-${index}`);
  btn.style.display = input.value.trim() ? "inline-block" : "none";
}

function submitCustomStatus(index) {
  const input = document.getElementById(`customInput-${index}`);
  const logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");

  if (!logs[index]) return;
  logs[index].status = input.value.trim();
  localStorage.setItem("taskLogs", JSON.stringify(logs));

  showBanner("Custom status saved!", "success");
  showLogs();
}

function updateLogStatus(index, newStatus) {
  const logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");
  if (!logs[index]) return;

  logs[index].status = newStatus;
  localStorage.setItem("taskLogs", JSON.stringify(logs));

  showBanner(`Marked as ${newStatus}!`, newStatus === "Completed" ? "success" : "warning");
  showLogs();
}

document.getElementById("viewLogsBtn").addEventListener("click", () => {
  showLogs();
  const modal = new bootstrap.Modal(document.getElementById("logsModal"));
  modal.show();
});

function renderPagination(totalPages){
    const pagination = document.getElementById("pagination");
    pagination.innerHTML="";
    if(totalPages<=1) return;
    pagination.innerHTML += `<li class="page-item ${currentPage===1?'disabled':''}"><a class="page-link" href="#" data-page="${currentPage-1}">Prev</a></li>`;
    let startPage = Math.max(1,currentPage-2);
    let endPage = Math.min(totalPages,currentPage+2);
    if(currentPage<=3) endPage=Math.min(5,totalPages);
    if(currentPage>=totalPages-2) startPage=Math.max(totalPages-4,1);
    for(let i=startPage;i<=endPage;i++){
        pagination.innerHTML += `<li class="page-item ${i===currentPage?'active':''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
    }
    pagination.innerHTML += `<li class="page-item ${currentPage===totalPages?'disabled':''}"><a class="page-link" href="#" data-page="${currentPage+1}">Next</a></li>`;
    document.querySelectorAll("#pagination .page-link").forEach(link=>{
        link.addEventListener("click",(e)=>{
            e.preventDefault();
            const page=parseInt(link.getAttribute("data-page"));
            if(page>=1 && page<=totalPages){ currentPage=page; filterTasks(); }
        });
    });
}

// --- NEW: TOAST NOTIFICATIONS ---
function showBanner(message, type="success") {
    const toastContainer = document.getElementById("toastContainer");
    
    let bgClass = "bg-success text-white";
    let closeBtnClass = "btn-close-white";
    
    if(type === "info") { bgClass = "bg-primary text-white"; }
    if(type === "warning") { bgClass = "bg-warning text-dark"; closeBtnClass = ""; }
    if(type === "secondary") { bgClass = "bg-secondary text-white"; }

    const toastEl = document.createElement("div");
    toastEl.className = `toast align-items-center border-0 ${bgClass} shadow-lg mb-2`;
    toastEl.setAttribute("role", "alert");
    toastEl.setAttribute("aria-live", "assertive");
    toastEl.setAttribute("aria-atomic", "true");
    
    toastEl.innerHTML = `
      <div class="d-flex">
        <div class="toast-body fw-bold">
          ${message}
        </div>
        <button type="button" class="btn-close ${closeBtnClass} me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    toastContainer.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl, { delay: 3500 });
    toast.show();
    
    toastEl.addEventListener('hidden.bs.toast', () => {
        toastEl.remove();
    });
}

function generateWorkLog() {
  const logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");
  if (logs.length === 0) {
    showBanner("No logs to generate.", "warning");
    return;
  }

  const reportDate = logs[0].date || new Date().toISOString().split("T")[0];

  const toProperCase = (str) => {
    if (!str) return "";
    if (str.includes("/")) return str;
    return str.toLowerCase().replace(/\b\w/g, s => s.toUpperCase());
  };

  const headers = ["Brand", "Task", "Task Name", "Status"];

  const rows = logs.map(l => {
    const brand = toProperCase(normalizeBrandName(l.brand));
    const taskCategory = l.subtask || ""; 
    const taskTitle = l.task || "";       
    const status = l.status || "";

    const escape = (txt) => `"${txt.replace(/"/g, '""')}"`;

    return `${escape(brand)},${escape(taskCategory)},${escape(taskTitle)},${escape(status)}`;
  });

  const csvContent = `Date: ${reportDate}\n` + [headers.join(","), ...rows].join("\n");

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);

  const estDate = new Date().toLocaleDateString("en-US", { timeZone: "America/New_York" }).replace(/\//g, "-");
  link.setAttribute("download", `DailyReport_${estDate}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  localStorage.removeItem("taskLogs");
  showBanner("Work log generated and cleared!", "success");

  checkLogToggle(); 
  
  // Close the modal and refresh UI so charts/buttons reset
  const modalEl = document.getElementById("logsModal");
  const modalObj = bootstrap.Modal.getInstance(modalEl);
  if(modalObj) modalObj.hide();
  filterTasks();
}

document.getElementById("generateLogBtn")?.addEventListener("click", generateWorkLog);


function updateLastUpdated(){
    const now=new Date();
    document.getElementById("lastUpdated").innerText=`Updated: ${now.toLocaleTimeString()}`;
}

function logout(){ localStorage.removeItem("agent"); location.reload(); }

document.addEventListener("visibilitychange", () => {
    if (!document.hidden) {
        newTaskCount = 0;
        updateFavicon(0);
    }
});

// ==========================================
// --- CURSOR PARTICLE EFFECT (OCTAGONS) ---
// ==========================================
const canvas = document.getElementById('cursorCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let particlesArray = [];

// --- 1. SINGLE COLOR HERE ---
// Change this hex code to whatever color you prefer! 
const particleColor = '#0d6efd'; 

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

const mouse = { x: undefined, y: undefined };

window.addEventListener('mousemove', (event) => {
    mouse.x = event.x;
    mouse.y = event.y;
    for (let i = 0; i < 2; i++) {
        particlesArray.push(new Particle());
    }
});

class Particle {
    constructor() {
        this.x = mouse.x;
        this.y = mouse.y;
        // Made them slightly larger (between 2 and 6) so the octagon shape is visible
        this.size = Math.random() * 4 + 2; 
        this.speedX = Math.random() * 3 - 1.5; 
        this.speedY = Math.random() * 3 - 1.5; 
        this.life = 1; 
    }
    
    update() {
        this.x += this.speedX;
        this.y += this.speedY;
        this.life -= 0.03; 
        if (this.size > 0.2) this.size -= 0.1; 
    }
    
    draw() {
        ctx.fillStyle = particleColor;
        ctx.globalAlpha = Math.max(0, this.life); 
        
        // --- 2. DRAWING THE OCTAGON ---
        ctx.beginPath();
        for (let j = 0; j < 8; j++) {
            // Divide a full circle (Math.PI * 2) into 8 equal angles
            const angle = (j * Math.PI * 2) / 8; 
            const pointX = this.x + this.size * Math.cos(angle);
            const pointY = this.y + this.size * Math.sin(angle);
            
            if (j === 0) {
                ctx.moveTo(pointX, pointY);
            } else {
                ctx.lineTo(pointX, pointY);
            }
        }
        ctx.closePath();
        ctx.fill();
    }
}

function handleParticles() {
    for (let i = 0; i < particlesArray.length; i++) {
        particlesArray[i].update();
        particlesArray[i].draw();
        
        if (particlesArray[i].life <= 0) {
            particlesArray.splice(i, 1);
            i--;
        }
    }
}

function animateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    handleParticles();
    requestAnimationFrame(animateParticles);
}

animateParticles();
</script>
</body>
</html>
