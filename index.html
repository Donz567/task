<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exclusive Task Manager</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚≠ê</text></svg>">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
body {
    background-color: #f8fafc;
    color: #1a1a1a;
    font-family: 'Segoe UI', Tahoma, sans-serif;
}
.navbar {
    background: #ffffff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.status-summary, .sbs-summary {
    display: flex;
    gap: 1rem;
    margin-left: 2rem;
    font-size: 0.9rem;
}
.status-summary div, .sbs-summary div {
    background: #f1f1f1;
    padding: 4px 10px;
    border-radius: 8px;
    font-weight: 600;
}
.task-card {
    border-radius: 12px;
    padding: 15px;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    background-color: #ffffff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}
.task-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}
.task-title {
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 5px;
}
.task-info {
    font-size: 0.85rem;
    margin-bottom: 3px;
}
.status-badge {
    padding: 2px 8px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-block;
}
.status-completed { background: #bcddc9; color: #1a1a1a; }
.status-ongoing { background: #d9eafd; color: #1a1a1a; }
.status-cancelled { background: #fdd9d9; color: #1a1a1a; }
.status-assigned { background: #f5f5d9; color: #1a1a1a; }
.bc-btn {
    background: #1a1a1a;
    color: #fff;
    text-decoration: none;
    border-radius: 8px;
    padding: 5px 10px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin-top: auto;
}
.bc-btn:hover { background: #333; text-decoration: none; }
#filterBar { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
#taskList { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr)); gap: 1rem; }

.label-badge {
    padding: 1px 5px;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-block;
    color: #1a1a1a;
    margin-bottom: 2px;
}

/* only for text background */
.label-task-text { background-color: #ffd54f; }
.label-subtask-text { background-color: #81c784; }
.label-brand-text { background-color: #64b5f6; }

/* Detail view styling */
#taskDetail {
    display: none;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 20px;
    margin-top: 20px;
    scroll-padding-top: 80px;
}
.task-item .copyBtn {
  opacity: 0;
  transition: opacity 0.2s;
}
.task-item:hover .copyBtn {
  opacity: 1;
}
.daily-reminder {
  position: fixed;
  top: 70px;
  right: 20px;
  z-index: 2000;
  background: #e3f2fd; /* üîµ light blue instead of yellow */
  padding: 15px;
  border: 1px solid #90caf9;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  max-width: 320px;
}
.daily-reminder ul {
  margin: 5px 0;
  padding-left: 20px;
  max-height: 150px;
  overflow-y: auto;
  font-size: 0.9rem;
}
.daily-reminder a {
  margin-left: 6px;
  font-size: 0.8rem;
  color: #1565c0;
  text-decoration: underline;
}
.task-item {
  cursor: pointer;
  transition: background-color 0.2s, box-shadow 0.2s;
  position: relative;
}

.task-item:hover {
  background-color: #e8f5e9; /* light green */
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.task-item .copied-indicator {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.85em;
  color: #28a745; /* Bootstrap success green */
  font-weight: bold;
}
.task-card {
 position: relative;
  display: flex;
  flex-direction: column;
  justify-content: space-between; /* pushes button down */
  overflow: hidden;
  
}
.task-card * {
  position: relative;
  z-index: 1;   /* keeps text and buttons above watermark */
}
.bc-btn-wrapper {
  margin-top: auto; /* ensures it stays at the bottom */
  width: 100%;
}

.bc-btn {
  display: block;
  width: 100%;
  text-align: center;
  background: #0e0f0f; /* Bootstrap primary color */
  color: white;
  padding: 5px;
  border-radius: 6px;
  text-decoration: none;
  font-weight: 500;
  transition: background 0.2s ease;
}

.bc-btn:hover {
  background: #35373b;
  color: white;
}

.task-bg-icon {
  position: absolute;
  right: 10px;
  bottom: 10px;         /* ‚úÖ push icon toward the bottom-right */
  font-size: 140px;     /* üî• big watermark */
  color: inherit;       /* adapts to card text color */
  opacity: 0.05;        /* faint like watermark */
  pointer-events: none; /* not clickable */
  z-index: 0;           /* stays behind text */
}
/* --- Stylish Bigger Toggle Switch --- */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 70px;
  height: 33px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.4s;
  border-radius: 36px;
  box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
}

.slider::before {
  position: absolute;
  content: "";
  height: 25px;
  width: 25px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
#detailTitle {
  cursor: pointer;
  position: relative;
}


/* ON State */
.toggle-switch input:checked + .slider {
  background-color: #0d6efd;
  box-shadow: 0 0 10px rgba(13, 110, 253, 0.8);
}

.toggle-switch input:checked + .slider::before {
  transform: translateX(34px);
}

/* Smooth hover */
.toggle-switch:hover .slider {
  box-shadow: 0 0 8px rgba(13, 110, 253, 0.4);
}
/* Loading Overlay */
.loading-overlay {
  position: fixed;
  inset: 0;
  background-color: rgba(255, 255, 255, 0.85);
  z-index: 2000;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: opacity 0.3s ease;
}

/* Sticky back + toggle bar */
.detail-header {
  position: sticky;
  top: 70px; /* Adjust based on navbar height */
  z-index: 1020;
  background: #fff;
  padding: 10px 0;
  
}

</style>
</head>
<body>
  <!-- Loading Spinner -->

<div id="banner" class="alert alert-success text-center position-fixed top-0 start-50 translate-middle-x w-50 d-none" role="alert" style="z-index:1055;">
</div>
<nav class="navbar navbar-expand-lg sticky-top p-3">
  <div class="container-fluid">
    
    <a class="navbar-brand fw-bold" href="#">üìã Task Manager</a>
    
    <div class="ms-auto d-flex align-items-center gap-2 flex-wrap">
    
    <button id="viewLogsBtn" class="btn btn-outline-info position-fixed bottom-0 end-0 m-3 shadow">
      <i class="bi bi-journal-text"></i> View Logs
    </button>
      <div class="status-summary" id="statusSummary"></div>
      <div class="sbs-summary" id="sbsSummary"></div>
      
      <div id="loginDropdownContainer"></div>
      <button class="btn btn-outline-danger btn-sm" id="logoutBtn" style="display:none;">Logout</button>
      <small class="text-muted ms-3" id="lastUpdated"></small>
      
    </div>
  </div>
</nav>

<div class="container py-4">


<!-- Logs Modal -->
<div class="modal fade" id="logsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content rounded-4">
      <div class="modal-header bg-primary text-white rounded-top-4">
        <h5 class="modal-title"><i class="bi bi-journal-text me-2"></i>Daily Work Logs</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-4">
        <div id="logsTableContainer" class="table-responsive">
          <p class="text-center text-muted mb-0">No logs recorded yet.</p>
        </div>
      </div>

      <div class="modal-footer d-flex justify-content-between">
        <button class="btn btn-outline-success" id="generateLogBtn">
          <i class="bi bi-file-earmark-excel"></i> Generate Daily Report
        </button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



  <div id="filterBar">
    <input type="text" id="searchBar" class="form-control form-control-sm" placeholder="Search tasks">
    <select id="statusFilter" class="form-select form-select-sm">
      <option value="all" selected>All Status / SBS</option>
    </select>
  </div>
  <div id="taskList" class="mb-4"></div>
  
  <!-- Detail view panel -->
  <div id="taskDetail"></div>
  
  <nav>
    <ul class="pagination justify-content-center" id="pagination"></ul>
  </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/1AEFog4va5g5Teg5yiOamSlwwlB4g-UOGT0NUkgz7UBA/gviz/tq?tqx=out:json";

let tasks = [];
let agents = new Set();
let sbsSet = new Set();
let currentPage = 1;
let lastTaskCount = 0;  
let newTaskCount = 0;    

const tasksPerPage = 20;
const agentMap = {
    "Adriana, Venz": "Venz",
    "Marisa, Venz": "Venz",
    "Venz, Adriana": "Venz",
    "Adriana, Marisa": "Marisa",
    "Marisa, Adriana": "Marisa",
    "Marisa, Marissa C": "Marisa",
    "Marisa, Venz": "Marisa",
    "Adriana, Peter": "Peter",
    "Peter, Jonathan": "Peter",
    "Adriana, Ezequel": "Ezequel",
    "Raven, Andrew": "Raven",
    "Adriana, Sedney": "Sedney",
    "Adriana, Jhonmar": "Jhonmar",
    "Adriana, Jade": "Jade",
};
document.addEventListener("DOMContentLoaded", () => {
    initApp();
    document.getElementById("searchBar").addEventListener("input", () => { currentPage = 1; filterTasks(); });
    document.getElementById("statusFilter").addEventListener("change", () => { currentPage = 1; filterTasks(); });
    document.getElementById("logoutBtn").addEventListener("click", logout);
    setInterval(() => { fetchTasks().then(() => filterTasks(true)); }, 30000);
});

async function initApp() {
    await fetchTasks();
    setupLogin();
    setupStatusFilter();
    filterTasks();
    requestNotificationPermission();
  setTimeout(notifyDailyOngoingTasks, 2000); // show reminder shortly after load
}
function normalizeBrandName(brand) {
  if (!brand) return brand;
  // Convert to consistent case for comparison
  const b = brand.trim().toLowerCase();
  if (b === "carolina/double h boots") return "Carolina/Double H";
  return brand;
}
function requestNotificationPermission() {
  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission();
  }
}

function getOngoingTasks() {
  const loginName = localStorage.getItem("agent");
  if (!loginName) return [];
  return tasks.filter(t => t["Agent Assigned"] === loginName && 
                          (t["Status"]||"").toLowerCase() === "ongoing");
}
function notifyDailyOngoingTasks() {
  const ongoing = getOngoingTasks();
  if (ongoing.length === 0) return;

  const today = new Date().toDateString();
  if (localStorage.getItem("lastOngoingNotify") === today) return;

  // Prepare list with Basecamp links
  const listHtml = ongoing.map(t => {
    let linkHtml = t["BC Link"] 
      ? `<a href="${t["BC Link"]}" target="_blank">(BC)</a>` 
      : "";
    return `<li>${t["Tasks"]} ${linkHtml}</li>`;
  }).join("");

  // Browser notification
  if ("Notification" in window && Notification.permission === "granted") {
    const message = ongoing.map(t => `- ${t["Tasks"]}`).join("\n");
    new Notification("Ongoing Tasks Reminder", {
      body: message,
      icon: "https://cdn-icons-png.flaticon.com/512/4436/4436481.png"
    });
  }

  // In-app popup
  const container = document.createElement("div");
  container.className = "daily-reminder";
  container.innerHTML = `
    <strong>üîî Daily Reminder</strong>
    <div>You have <b>${ongoing.length}</b> ongoing tasks:</div>
    <ul>${listHtml}</ul>
    <button class="btn btn-sm btn-outline-secondary mt-2">Dismiss</button>
  `;
  document.body.appendChild(container);
  container.querySelector("button").onclick = () => container.remove();

  localStorage.setItem("lastOngoingNotify", today);
}
function showLoading() {
  document.getElementById("loadingOverlay")?.classList.remove("d-none");
}

function hideLoading() {
  document.getElementById("loadingOverlay")?.classList.add("d-none");
}
function parseSheetDate(value) {
    if (!value) return null;

    // Check if value is in "Date(YYYY,MM,DD)" format
    const match = value.match(/Date\((\d+),(\d+),(\d+)\)/);
    if (match) {
        const year = parseInt(match[1]);
        const month = parseInt(match[2]); // JS months are 0-indexed
        const day = parseInt(match[3]);
        return new Date(year, month, day);
    }

    // Fallback: try numeric (Google Sheets epoch)
    if (!isNaN(value)) {
        const epoch = new Date(1899, 11, 30);
        return new Date(epoch.getTime() + Number(value) * 24 * 60 * 60 * 1000);
    }

    // Fallback: try standard JS date parsing
    const date = new Date(value);
    if (!isNaN(date)) return date;

    return null; // failed to parse
}

function formatDate(date) {
    if (!date) return "N/A";
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2,'0'); // add +1 here
    const d = String(date.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
}
async function fetchTasks() {
 
    try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
       tasks = json.table.rows.flatMap((row, i) => {
        let obj = {};
        json.table.cols.forEach((col, j) => { 
            obj[col.label] = row.c[j] ? row.c[j].v : ""; 
        });
        obj["Brand"] = normalizeBrandName(obj["Brand"]);
        obj["_id"] = i;
         console.log("Raw Date Assigned:", obj["Date Assigned"]);
        obj._dateParsed = parseSheetDate(obj["Date Assigned"]);
console.log("Parsed Date:", obj._dateParsed);
        // Get all agents this task should belong to
        const agentsAssigned = (obj["Agent Assigned"] || "")
            .split(",")                  // split by comma
            .map(a => a.trim())          // trim spaces
            .map(a => agentMap[a] || a) // map if exists
            .filter(a => a);             // remove empty

        // Add each agent separately
        return agentsAssigned.map(agent => {
            const copy = {...obj};
            copy["Agent Assigned"] = agent;
            if(agent) agents.add(agent);         // add to agents set
            if(obj["TM's Note"]) sbsSet.add(obj["TM's Note"]); // add TM's Note
            return copy;
        });
    });


        tasks.sort((a,b) => b._id - a._id); // newest first

        const loginName = localStorage.getItem("agent");
        if (loginName) {
            const currentCount = tasks.filter(t => t["Agent Assigned"] === loginName).length;
            if (lastTaskCount > 0 && currentCount > lastTaskCount) {
                newTaskCount += (currentCount - lastTaskCount);
                updateFavicon(newTaskCount);
            }
            lastTaskCount = currentCount;
        }

        updateLastUpdated();
        updateStatusSummary();
        updateSBSSummary();
    } catch(err) { console.error("Error fetching tasks:", err); }
  
}

function setupLogin() {
    const agentMap = {
        "Adriana, Venz": "Venz",
        "Marisa, Venz": "Venz",
        "Venz, Adriana": "Venz",
        "Adriana, Marisa": "Marisa",
        "Marisa, Adriana": "Marisa",
        "Marisa, Marissa C": "Marisa",
        "Marisa, Venz": "Marisa",
        "Adriana, Peter": "Peter",
        "Peter, Jonathan": "Peter",
        "Adriana, Ezequel": "Ezequel",
        "Raven, Andrew": "Raven",
        "Adriana, Sedney": "Sedney",
        "Adriana, Jhonmar": "Jhonmar",
        "Adriana, Jade": "Jade",
    };

    const loginName = localStorage.getItem("agent");
    if(loginName){
        document.getElementById("logoutBtn").style.display="inline-block";
        document.getElementById("loginDropdownContainer").innerHTML = `<span class="fw-bold text-primary">${loginName}</span>`;
    } else {
        // Normalize agents for dropdown
        let normalizedAgents = new Set();
        agents.forEach(agent => {
            if(agentMap[agent]) normalizedAgents.add(agentMap[agent]);
            else normalizedAgents.add(agent);
        });

        let dropdownHTML = `<select class="form-select form-select-sm" id="loginDropdown"><option selected disabled>Login as...</option>`;
        normalizedAgents.forEach(agent => { dropdownHTML += `<option value="${agent}">${agent}</option>`; });
        dropdownHTML += `</select>`;
        document.getElementById("loginDropdownContainer").innerHTML = dropdownHTML;

        document.getElementById("loginDropdown").addEventListener("change", (e) => {
            localStorage.setItem("agent", e.target.value);
            location.reload();
        });
    }
}


function setupStatusFilter(){
    const statusFilter = document.getElementById("statusFilter");
    const statuses = ["ongoing","completed","cancelled","assigned"];
    statuses.forEach(s => { statusFilter.innerHTML += `<option value="${s}">${capitalize(s)}</option>`; });
    Array.from(sbsSet).forEach(sbs => { statusFilter.innerHTML += `<option value="SBS:${sbs}">${sbs}</option>`; });
}

function capitalize(str){ return str.charAt(0).toUpperCase() + str.slice(1); }

function filterTasks(isRefresh=false){
    const loginName = localStorage.getItem("agent");
    if(!loginName) return;

    fetchTasks().then(() => { // <-- fetch latest tasks first
        const search = document.getElementById("searchBar").value.toLowerCase();
        const statusFilter = document.getElementById("statusFilter").value;
        let filtered = tasks.filter(t => t["Agent Assigned"]===loginName);
        if(statusFilter !== "all"){
            if(statusFilter.startsWith("SBS:")){
                const sbsValue = statusFilter.slice(4);
                filtered = filtered.filter(t => t["TM's Note"] === sbsValue);
            } else {
                filtered = filtered.filter(t => (t["Status"]||"").toLowerCase()===statusFilter);
            }
        }
        filtered = filtered.filter(t => Object.values(t).some(val => String(val).toLowerCase().includes(search)));
    renderTasks(filtered,isRefresh);
    //updateStatusSummary(filtered);
    //updateSBSSummary(filtered);
    updateTotalTasks(filtered);
    });
}

function updateStatusSummary() {
    const summaryEl = document.getElementById("statusSummary");
    const loginName = localStorage.getItem("agent");
    if(!loginName) return;

    // Count all tasks for this agent, ignoring filters
    const data = tasks.filter(t => t["Agent Assigned"] === loginName);
    const counts = {ongoing:0, completed:0, cancelled:0, assigned:0};
    data.forEach(t => {
        const s = (t["Status"]||"").toLowerCase();
        if(counts[s] !== undefined) counts[s]++;
    });

    summaryEl.innerHTML = `
        <div class="status-badge status-assigned">Total Task: ${data.length}</div>
        <div class="status-badge status-ongoing">Ongoing: ${counts.ongoing}</div>
        <div class="status-badge status-completed">Completed: ${counts.completed}</div>
        <div class="status-badge status-cancelled">Cancelled: ${counts.cancelled}</div>
        <div class="status-badge status-assigned">Assigned: ${counts.assigned}</div>
    `;
}

function updateSBSSummary(filteredTasks = null) {
    const summaryEl = document.getElementById("sbsSummary");
    const loginName = localStorage.getItem("agent");
    if (!loginName) return;

    const data = filteredTasks || tasks.filter(t => t["Agent Assigned"] === loginName);

    // Total SBS: count all tasks with TM's Note
    const totalSBS = data.filter(t => t["TM's Note"]).length;

    // Display only Total SBS
    summaryEl.innerHTML = `<div>Total SBS: ${totalSBS}</div>`;
}



function updateFavicon(count) {
  const canvas = document.createElement("canvas");
  canvas.width = 64;
  canvas.height = 64;
  const ctx = canvas.getContext("2d");

  // 1. Draw star emoji (Shifted slightly left to make room for badge)
  ctx.font = "54px Segoe UI Emoji";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("‚≠ê", 26, 38); 

  // 2. Draw Red Badge (Much Bigger)
  if (count > 0) {
    ctx.beginPath();
    // Circle centered at top-right (x=46, y=18), Radius=22 (Big!)
    ctx.arc(46, 18, 22, 0, 2 * Math.PI); 
    ctx.fillStyle = "#ff0000"; // Bright Red
    ctx.fill();
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#ffffff"; // White border to separate from star
    ctx.stroke();

    // 3. Draw Number (Big & Bold)
    ctx.fillStyle = "white";
    ctx.font = "bold 28px Arial"; // Increased font size significantly
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    // Adjust text position slightly to center in the circle
    ctx.fillText(count > 99 ? "99+" : count, 46, 19); 
  }

  // Apply favicon
  const link = document.querySelector("link[rel='icon']") || document.createElement("link");
  link.rel = "icon";
  link.href = canvas.toDataURL("image/png");
  document.head.appendChild(link);
}


function renderTasks(taskArray){
    const taskList = document.getElementById("taskList");
    taskList.innerHTML = ""; // always clear first

    const totalPages = Math.ceil(taskArray.length/tasksPerPage);
    const start = (currentPage-1)*tasksPerPage;
    const paginated = taskArray.slice(start,start+tasksPerPage);

    paginated.forEach(t => {
        const status = (t["Status"]||"").toLowerCase();
        const bcLink = t["BC Link"] || "#";
        const brand = normalizeBrandName(t["Brand"]) || "N/A";

        const card = document.createElement("div");
        card.className = "task-card";
        card.innerHTML = `
            
                <div class="task-title">${t["Tasks"]||"Untitled"}</div>

                <!-- Brand -->
              <div class="task-info">
                    <i class="bi bi-tags text-primary"></i>
                    <span class="label-badge label-brand-text">${brand}</span>
                  </div>

                  <div class="task-info">
                    <i class="bi bi-list-task text-warning"></i>
                    <span class="label-badge label-task-text">${t["Task"]||"N/A"}</span>
                  </div>

                  <div class="task-info">
                    <i class="bi bi-check2-square text-success"></i>
                    <span class="label-badge label-subtask-text">${t["Sub-Task"]||"N/A"}</span>
                  </div>
                  <!-- Status -->
                    <div class="task-info">
                      <i class="bi bi-flag text-info"></i>
                      <span class="status-badge status-${(t["Status"]||"N/A").toLowerCase()}">
                        ${t["Status"] || "N/A"}
                      </span>
                    </div>

                  <div class="task-info">
                    <i class="bi bi-calendar-event text-primary"></i>
                    ${formatDate(t._dateParsed) || "N/A"}
                  </div>
                </div>

                <a href="${bcLink}" target="_blank" class="bc-btn">
                  <i class="bi bi-link-45deg"></i> BC Link
                </a>

            ${getBackgroundIcon(status)}
        `;
        card.addEventListener("click", (e)=>{
            if (!e.target.closest(".bc-btn")) showDetail(t);
        });
        taskList.appendChild(card);
    });

    renderPagination(totalPages);
}
function getBackgroundIcon(status) {
  switch(status) {
    case "ongoing": 
      return `<i class="bi bi-hourglass-split task-bg-icon text-primary"></i>`;
    case "completed": 
      return `<i class="bi bi-check2-circle task-bg-icon text-success"></i>`;
    case "cancelled": 
      return `<i class="bi bi-slash-circle task-bg-icon text-danger"></i>`;
    case "assigned": 
      return `<i class="bi bi-person-workspace task-bg-icon text-warning"></i>`;
    default: 
      return ``;
  }
}

function showDetail(task) {
    const taskListEl = document.getElementById("taskList");
    const paginationEl = document.getElementById("pagination");
    const filterBarEl = document.getElementById("filterBar");
    const detailEl = document.getElementById("taskDetail");

    // Hide main view
    taskListEl.style.display = "none";
    paginationEl.style.display = "none";
    filterBarEl.style.display = "none";
    detailEl.style.display = "block";

    const cardTitle = task["Tasks"] || "Untitled";
    const brand = normalizeBrandName(task["Brand"] || "nobrand").toLowerCase();
    
    const status = (task["Status"] || "N/A").toLowerCase();
    const dateAssigned = formatDate(task._dateParsed);
    const sbsNote = task["TM's Note"] || "";
    const bcLink = task["BC Link"] || "#";
    
    function statusClass(s) {
        if (s === "completed") return "status-completed";
        if (s === "ongoing") return "status-ongoing";
        if (s === "cancelled") return "status-cancelled";
        if (s === "assigned") return "status-assigned";
        return "badge bg-secondary";
    }

    // --- CATEGORIES DATA ---
    const categories = { 
        "Validation": [ "[brand]-validating-data for new supplier", "[brand]-validating-upc list source" ], 
        "Analysis": [ "[brand]-analyzing-task prioritization", "[brand]-analyzing-new supplier source", "[brand]-analyzing-existing supplier source", "[brand]-analyzing-bulk order source", "[brand]-analyzing-prebook order source", "[brand]-analyzing-inventory for deletion", "[brand]-analyzing-listing loader request", "[brand]-analyzing-shopify source", "analyzing-manage experiment", "[brand]-analyzing-shopkeep source" ], 
        "Gathering Data": [ "[brand]-gathering-new supplier data", "[brand]-gathering-existing supplier data", "[brand]-gathering-bulk/preebook data", "[brand]-gathering-enhancement data", "[brand]-gathering-flat file data", "[brand]-gathering-pre existing asins", "[brand]-gathering-skus for deletion", "[brand]-gathering-brand store data", "[brand]-gathering-shopify data", "[brand]-gathering-shopkeep data", "[brand]-gathering-skus for deletion", "[brand]-gathering-SIPV", "[brand]-gathering-manage experiment", "all brands-gathering-voice of the customer", "all brands-gathering-suppressed listings", "all brands-gathering-stranded listings", "all brands-gathering-standalone listings" ], 
        "Creation": [ "[brand]-creating-new supplier masterlist", "[brand]-creating-existing supplier masterlist", "[brand]-creating- bulk/prebook masterlist", "[brand]-creating-new supplier listing loader file", "[brand]-creating-existing supplier listing loader file", "[brand]-creating-bulk/prebook listing loader file", "[brand]-creating-new supplier ilf", "[brand]-creating-existing supplier ilf", "[brand]-creating-bulk/prebook ilf", "[brand]-creating-new supplier cost sheet", "[brand]-creating-new supplier sku upc list", "[brand]-creating-existing supplier cost sheet", "[brand]-creating-existing supplier sku upc list", "[brand]-creating-bulk/prebook cost sheet", "[brand]-creating-bulk/prebook sku upc list", "[brand]-creating-existing supplier advertising campaign list", "[brand]-creating-flat file enhancement", "[brand]-creating-flat file listing concern", "creating-manage experiment", "[brand]-creating-ebc enhancement" ], 
        "Verification / Image Update": [ "[brand]-verifying-upc match manual", "[brand]-verifying-data central result", "[brand]-verifying-listing loader request", "[brand]-verifying-image urls", "[brand]-enhancing-images for enhancement", "[brand]-updating-sas flat file", "[brand]-updating-listing in amazon", "[brand]-updating-edit page manually enhancement" ], 
        "Review / Upload": [ "[brand]-reviewing-all files", "[brand]-reviewing-newly uploaded listings", "[brand]-uploading-ilf", "[brand]-uploading-flat file", "[brand]-uploading-shipping plan", "[brand]-uploading-weights and dimensions", "[brand]-uploading-video", "[brand]-uploading-images", "[brand]-attaching-files in bc", "[brand]-reviewing-all files enhancement", "[brand]-attaching-files in bc enhancement", "[brand]-uploading-flat file enhancement", "[brand]-uploading-video enhancement" ], 
        "Investigation / Fixing / Correction": [ "[brand]-investigating-listing issue", "[brand]-fixing-suppressed/quality alerts", "[brand]-fixing-stranded inventory", "[brand]-fixing-standalone", "[brand]-correcting-masterlist file", "[brand]-correcting-ilf", "[brand]-correcting-cost sheet", "[brand]-correcting-sku-upc list", "[brand]-correcting-flatfile error", "[brand]-investigating-pesticide marking", "[brand]-fixing-listing issue", "[brand]-investigating-listing enhancement", "[brand]-correcting-flatfile error enhancement", "[brand]-investigating-SIP", "[brand]-investigating-policy warning", "[brand]-investigating-inaccurate condition complaint" ], 
        "Update / Send & Monitor Case": [ "[brand]-updating-trackers", "[brand]-updating-ebc", "[brand]-updating-search terms", "[brand]-sending-amazon case", "[brand]-sending-sas email", "[brand]-checking-amazon case & ff ups", "[brand]-checking-sas response", "[brand]-sending-sas ops", "[brand]-sending-amazon case enhancement", "[brand]-checking-amazon case & ff ups enhancement", "[brand]-updating-ebc enhancement", "[brand]-updating-search terms enhancement", "[brand]-sending-appeal" ], 
        "Monitoring": [ "none-checking-skype concerns", "none-checking-email concerns", "none-checking-basecamp notifications", "none-prioritizing tasks", "none-addressing-concerns-via skype", "none-addressing-concerns-via email", "none-addressing-concerns-via basecamp", "[brand]-logging-in 2P account", "[brand]-logging-in 1P account" ], 
        "Admin": [ "admin-break", "admin-training:[task]-{person}", "admin-feedbacking-[name of person/group]", "admin-assisting-[task] [name of person/group]", "admin-meeting-{name of person/group}", "admin-coaching-{name of person/group}", "sbs-certifying-[task name]-[name of agent]", "admin-observing:[task]-[name of person]", "admin-meeting-team-listing ex", "admin-1on1-[name]", "[brand]-creating-flat file", "[brand]-updating-listing in amazon (manual)", "[brand]-creating-listing in amazon (manual)", "[brand]-creating-deletion file", "[brand]-gathering-images for EBC", "[brand]-creating-ebc enhancement", "[brand]-updating-ebc enhancement", "[brand]-certify-" ] 
    };

    let rendered = "";
    for (const [header, items] of Object.entries(categories)) {
        const processed = items.map(t => {
            const lower = t.toLowerCase();
            if (lower.startsWith("admin") || lower.startsWith("none")) return t;
            if (t.includes("[brand]")) {
                return t.replace(/\[brand\]/g, brand) + ` (${cardTitle})`;
            }
            return t;
        });

        rendered += `
        <h6 class="mt-3 mb-2 fw-bold text-primary">${header}</h6>
        <div class="row">
            ${processed.map(item => `
                <div class="col-md-6 mb-2">
                    <div class="task-item d-flex align-items-center border rounded px-2 py-1 small bg-light text-truncate" title="Click to copy">
                        <span class="flex-grow-1 me-2">${item}</span>
                    </div>
                </div>
            `).join("")}
        </div>
        `;
    }

    // --- INJECT HTML ---
    detailEl.innerHTML = `
    <div class="detail-header d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-3">
          <button class="btn btn-sm btn-outline-secondary" id="backBtn">
            <i class="bi bi-arrow-left"></i> Back to Tasks
          </button>
          <label class="toggle-switch">
            <input type="checkbox" id="logToggle" onchange="toggleLog(this)">
            <span class="slider"></span>
          </label>
          <span class="fw-bold text-secondary">Working?</span>
        </div>

        ${
          normalizeBrandName(task["Brand"]).toLowerCase() === "vertx"
            ? `<div class="d-flex align-items-center gap-2">
                 <span class="fw-bold text-secondary">Tool:</span>
                 <a href="https://donz567.github.io/whiteeditor/" target="_blank" 
                    class="btn btn-outline-dark rounded-pill px-2 py-1">Image Editor</a>
               </div>`
            : ""
        }
    </div>
    
    <h5 class="mb-2" id="detailTitle">${cardTitle}</h5>
    <div class="mb-3 d-flex flex-wrap gap-1 align-items-center" style="font-size: 0.8rem;">
        <span class="badge bg-primary" id="detailBrand">${brand}</span>
        <span class="badge bg-success label-subtask-text">${task["Sub-Task"] || "N/A"}</span>
        <span class="badge ${statusClass(status)}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
        ${sbsNote ? `<span class="badge bg-warning text-dark">${sbsNote}</span>` : ""}
        <span class="text-muted">üìÖ ${dateAssigned}</span>
        ${bcLink !== "#" ? `<a href="${bcLink}" target="_blank" class="text-decoration-none">üîó BC Link</a>` : ""}
    </div>

    <div class="d-flex flex-wrap gap-2 mb-2" id="bubbleContainer"></div>

    <input type="text" class="form-control form-control-sm mb-3" id="templateSearch" autocomplete="off" placeholder="Type to search... (Auto-saves after 2 seconds)">
    
    <div id="templateList">${rendered}</div>
    `;

    // --- LOGIC SETUP ---
    const searchInput = document.getElementById("templateSearch");
    let debounceTimer; // ‚è≥ Timer variable
    
    // --- FUNCTION TO REFRESH BUBBLES IMMEDIATELY ---
    function refreshBubbles() {
        let recentSearches = JSON.parse(localStorage.getItem("recentSearches") || "[]");
        
        // Clean Duplicates
        recentSearches = recentSearches.filter((item, index, self) =>
            index === self.findIndex((t) => (t.toLowerCase() === item.toLowerCase()))
        );

        // Limit to 15
        if (recentSearches.length > 15) {
            recentSearches = recentSearches.slice(0, 15);
            localStorage.setItem("recentSearches", JSON.stringify(recentSearches));
        }

        if (recentSearches.length === 0) {
            recentSearches = ["Validating", "Analyzing", "Gathering", "Creation", "Admin"];
        }

        const bubblesHtml = recentSearches.map(term => 
            `<button type="button" class="btn btn-sm btn-outline-primary rounded-pill search-bubble mb-1" style="font-size: 0.75rem;">${term}</button>`
        ).join(" ");

        const container = document.getElementById("bubbleContainer");
        container.innerHTML = bubblesHtml;

        // Re-attach listeners to new bubbles
        container.querySelectorAll(".search-bubble").forEach(btn => {
            btn.addEventListener("click", () => {
                const val = btn.textContent;
                searchInput.value = val;
                performSearch(val);
            });
        });
    }

    function performSearch(term) {
        const lowerTerm = term.toLowerCase();
        document.querySelectorAll("#templateList h6").forEach(header => {
            const section = header.nextElementSibling;
            let anyVisible = false;
            section.querySelectorAll(".col-md-6").forEach(div => {
                const match = div.innerText.toLowerCase().includes(lowerTerm);
                div.style.display = match ? "" : "none";
                if (match) anyVisible = true;
            });
            header.style.display = anyVisible ? "" : "none";
            section.style.display = anyVisible ? "" : "none";
        });
    }

    // üî• MODIFIED LISTENER: Search Instantly + Save after 2 Seconds
    searchInput.addEventListener("input", (e) => {
        const val = e.target.value;
        
        // 1. Filter the list immediately
        performSearch(val);

        // 2. Clear the previous timer (reset the countdown)
        clearTimeout(debounceTimer);

        // 3. Start a new 2-second countdown
        debounceTimer = setTimeout(() => {
            const trimmedVal = val.trim();
            if (trimmedVal.length > 2) {
                // Save logic
                let history = JSON.parse(localStorage.getItem("recentSearches") || "[]");
                history = history.filter(h => h.toLowerCase() !== trimmedVal.toLowerCase());
                history.unshift(trimmedVal);
                
                if (history.length > 15) history = history.slice(0, 15);
                
                localStorage.setItem("recentSearches", JSON.stringify(history));
                
                // Refresh UI immediately
                refreshBubbles();
            }
        }, 2000); // 2000ms = 2 seconds
    });

    // Initial Load of bubbles
    refreshBubbles();

    const titleEl = detailEl.querySelector("#detailTitle");
    titleEl.addEventListener("click", () => {
        navigator.clipboard.writeText(titleEl.textContent.trim()).then(() => showCopied(titleEl));
    });

    detailEl.querySelectorAll(".task-item").forEach(item => {
        item.addEventListener("click", e => {
            e.stopPropagation();
            navigator.clipboard.writeText(item.querySelector("span").innerText).then(() => showCopied(item));
        });
    });

    function showCopied(element) {
        const old = element.querySelector(".copied-indicator");
        if (old) old.remove();
        const indicator = document.createElement("span");
        indicator.className = "copied-indicator";
        indicator.innerText = "‚úÖ Copied!";
        indicator.style.marginLeft = "8px"; 
        indicator.style.color = "#28a745";
        element.appendChild(indicator);
        setTimeout(() => indicator.remove(), 1000);
    }

    document.getElementById("backBtn").addEventListener("click", () => {
        taskListEl.style.display = "grid";
        paginationEl.style.display = "flex";
        filterBarEl.style.display = "flex";
        detailEl.style.display = "none";
    });

    checkLogToggle();
}

function toggleLog(toggleEl) {
  const taskTitle = document.getElementById("detailTitle")?.textContent?.trim() || "Unknown Task";
  const brand = document.getElementById("detailBrand")?.textContent?.trim() || "Unknown Brand";
  const subTask = document
  .querySelector("#taskDetail .label-subtask-text")
  ?.textContent?.trim() || "N/A";


  const now = new Date();
  const hour = now.getHours();
  const workDate = new Date();

  // 12AM‚Äì8AM belongs to previous workday
  if (hour < 8) workDate.setDate(workDate.getDate() - 1);
  const dateStr = workDate.toISOString().split("T")[0];

  let logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");

  if (toggleEl.checked) {
    // check if same task+brand already logged today
    const already = logs.some(l => l.date === dateStr && l.task === taskTitle && l.brand === brand);
    if (!already) {
      logs.push({
        date: dateStr,
        task: taskTitle,
        brand: brand,
        subtask: subTask,
        timestamp: now.toISOString(),
      });
      localStorage.setItem("taskLogs", JSON.stringify(logs));
      showBanner(`Logged "${taskTitle}" (${brand}) for ${dateStr}`, "info");
    } else {
      showBanner(`Already logged "${taskTitle}" today`, "primary");
    }
  } else {
    // remove only that task‚Äôs record for today
    logs = logs.filter(l => !(l.date === dateStr && l.task === taskTitle && l.brand === brand));
    localStorage.setItem("taskLogs", JSON.stringify(logs));
    showBanner(`Removed "${taskTitle}" from ${dateStr}`, "secondary");
  }
}

// When showing details of a task, make toggle reflect that task‚Äôs current status
// When showing details of a task, make toggle reflect that task‚Äôs current status
function checkLogToggle() {
  const toggle = document.getElementById("logToggle");
  if (!toggle) return;

  const taskTitle = document.getElementById("detailTitle")?.textContent?.trim() || "";
  const brand = document.getElementById("detailBrand")?.textContent?.trim() || "";

  const now = new Date();
  const hour = now.getHours();
  const workDate = new Date();
  
  // Logic to determine "Shift Date" (If it's 1AM, it belongs to previous day's shift)
  if (hour < 8) workDate.setDate(workDate.getDate() - 1);
  const dateStr = workDate.toISOString().split("T")[0];

  const logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");
  const already = logs.some(l => l.date === dateStr && l.task === taskTitle && l.brand === brand);

  // --- UPDATED LOGIC HERE ---
  // Allow Start: 17 (5 PM)
  // Allow End: 12 (12 Noon next day)
  // This covers 5 PM, 6 PM, 7 PM, Midnight, and morning hours.
  if (hour >= 17 || hour < 12) {
    toggle.checked = already;
    const label = document.querySelector('.fw-bold.text-secondary');
    
    if (toggle.checked) {
      label.style.color = '#0d6efd';
      label.style.textShadow = '0 0 8px rgba(13,110,253,0.6)';
    } else {
      label.style.color = '#6c757d';
      label.style.textShadow = 'none';
    }

    toggle.disabled = false;
  } else {
    // Outside of work hours (12 PM to 5 PM), disable it
    toggle.checked = false;
    toggle.disabled = true;
  }
}

// Clean up logs for days older than yesterday after 8AM
// Clean up logs for days older than yesterday after 1 PM (13:00)
(function cleanOldLogs() {
  const now = new Date();
  const hour = now.getHours();
  // Changed from 8 to 13 (1 PM) to allow late morning work
  if (hour >= 13) {
    let logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");
    const today = new Date();
    const todayStr = today.toISOString().split("T")[0];
    // Keep only today's logs
    logs = logs.filter(l => l.date === todayStr);
    localStorage.setItem("taskLogs", JSON.stringify(logs));
  }
})();

document.getElementById("viewLogsBtn")?.addEventListener("click", showLogs);

// Function to show logs in modal with status controls
// ‚úÖ Replace all of your old showLogs() + updateLogStatus() with this
function showLogs() {
  const logsTableContainer = document.getElementById("logsTableContainer");
  const logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");

  if (!Array.isArray(logs) || logs.length === 0) {
    logsTableContainer.innerHTML = `<p class="text-center text-muted mb-0">No logs recorded yet.</p>`;
    return;
  }

  let html = `
    <table class="table table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Date</th>
          <th>Brand</th>
          <th>Sub-Task</th>
          <th>Task</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
  `;

  logs.forEach((log, index) => {
    const currentStatus = log.status || "";
    const isCustom =
      currentStatus &&
      !["Completed", "Ongoing"].includes(currentStatus);

    html += `
      <tr>
        <td>${log.date || "N/A"}</td>
        <td>${log.brand || "N/A"}</td>
        <td>${log.subtask || "N/A"}</td>
        <td>${log.task || "N/A"}</td>
        <td>${log.status || "N/A"}</td>
        <td>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <button type="button" class="btn btn-sm btn-success" onclick="updateLogStatus(${index}, 'Completed')">Completed</button>
            <button type="button" class="btn btn-sm btn-warning" onclick="updateLogStatus(${index}, 'Ongoing')">Ongoing</button>
            <div class="d-flex align-items-center flex-grow-1">
              <input 
                type="text" 
                class="form-control form-control-sm me-2" 
                id="customInput-${index}" 
                placeholder="Custom status..."
                value="${isCustom ? currentStatus : ''}"
                oninput="toggleSubmitButton(${index})"
              >
              <button 
                id="submitBtn-${index}" 
                class="btn btn-sm btn-primary" 
                style="display:${isCustom ? 'inline-block' : 'none'}"
                onclick="submitCustomStatus(${index})"
              >
                Submit
              </button>
            </div>
          </div>
        </td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  logsTableContainer.innerHTML = html;
}

// ‚úÖ Show/Hide Submit button dynamically
function toggleSubmitButton(index) {
  const input = document.getElementById(`customInput-${index}`);
  const btn = document.getElementById(`submitBtn-${index}`);
  btn.style.display = input.value.trim() ? "inline-block" : "none";
}

// ‚úÖ Save a custom typed status
function submitCustomStatus(index) {
  const input = document.getElementById(`customInput-${index}`);
  const logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");

  if (!logs[index]) return;
  logs[index].status = input.value.trim();
  localStorage.setItem("taskLogs", JSON.stringify(logs));

  showBanner("Custom status saved!", "success");
  showLogs();
}

// ‚úÖ For buttons (Completed / Ongoing)
function updateLogStatus(index, newStatus) {
  const logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");
  if (!logs[index]) return;

  logs[index].status = newStatus;
  localStorage.setItem("taskLogs", JSON.stringify(logs));

  showBanner(`Marked as ${newStatus}!`, newStatus === "Completed" ? "success" : "warning");
  showLogs();
}

// ‚úÖ Simple feedback banner
function showBanner(message, type = "info") {
  const banner = document.createElement("div");
  banner.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x shadow`;
  banner.style.zIndex = 3000;
  banner.style.marginTop = "10px";
  banner.innerText = message;
  document.body.appendChild(banner);
  setTimeout(() => banner.remove(), 3000);
}

// ‚úÖ Event to show modal and load logs
document.getElementById("viewLogsBtn").addEventListener("click", () => {
  showLogs();
  const modal = new bootstrap.Modal(document.getElementById("logsModal"));
  modal.show();
});

function statusClass(status){
    if(status==="completed") return "status-completed";
    if(status==="ongoing") return "status-ongoing";
    if(status==="cancelled") return "status-cancelled";
    if(status==="assigned") return "status-assigned";
    return "";
}

function renderPagination(totalPages){
    const pagination = document.getElementById("pagination");
    pagination.innerHTML="";
    if(totalPages<=1) return;
    pagination.innerHTML += `<li class="page-item ${currentPage===1?'disabled':''}"><a class="page-link" href="#" data-page="${currentPage-1}">Prev</a></li>`;
    let startPage = Math.max(1,currentPage-2);
    let endPage = Math.min(totalPages,currentPage+2);
    if(currentPage<=3) endPage=Math.min(5,totalPages);
    if(currentPage>=totalPages-2) startPage=Math.max(totalPages-4,1);
    for(let i=startPage;i<=endPage;i++){
        pagination.innerHTML += `<li class="page-item ${i===currentPage?'active':''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
    }
    pagination.innerHTML += `<li class="page-item ${currentPage===totalPages?'disabled':''}"><a class="page-link" href="#" data-page="${currentPage+1}">Next</a></li>`;
    document.querySelectorAll("#pagination .page-link").forEach(link=>{
        link.addEventListener("click",(e)=>{
            e.preventDefault();
            const page=parseInt(link.getAttribute("data-page"));
            if(page>=1 && page<=totalPages){ currentPage=page; filterTasks(); }
        });
    });
}

function showBanner(message) {
  const banner = document.getElementById("banner");
  banner.textContent = message;
  banner.classList.remove("d-none");
  setTimeout(() => banner.classList.add("d-none"), 3000);
}
// === Generate and Download Excel Log ===
// === Generate and Download Excel Log ===
function generateWorkLog() {
  const logs = JSON.parse(localStorage.getItem("taskLogs") || "[]");
  if (logs.length === 0) {
    showBanner("No logs to generate.", "warning");
    return;
  }

  // 1. Get Current Date in EST
  const estDate = new Date().toLocaleDateString("en-US", {
    timeZone: "America/New_York",
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });

  // 2. Helper to make text "Proper Case" (e.g. "adidas" -> "Adidas")
  const toProperCase = (str) => {
    if (!str) return "";
    if (str.includes("/")) return str; 
    return str.toLowerCase().replace(/\b\w/g, s => s.toUpperCase());
  };

  // 3. Prepare Data (Applying Proper Case here)
  const data = logs.map(l => ({
    Brand: toProperCase(normalizeBrandName(l.brand)),
    SubTask: l.subtask || "",
    Task: l.task || "",
    Status: l.status || ""
  }));

  // 4. Build CSV Content
  const csvContent =
    `Date: ${estDate}\n\n` + 
    "Brand,Sub-Task,Task,Status\n" +
    data.map(d => {
      return `"${d.Brand}","${d.SubTask}","${d.Task}","${d.Status}"`;
    }).join("\n");

  // 5. Create Download
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);

  const safeDateName = estDate.replace(/ /g, "_").replace(/,/g, "");
  const fileName = `DailyReport_${safeDateName}.csv`;
  
  link.setAttribute("download", fileName);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  localStorage.removeItem("taskLogs");
  showBanner("Work log generated and cleared from storage.", "success");
}

// Attach to button
document.getElementById("generateLogBtn")?.addEventListener("click", generateWorkLog);


function updateLastUpdated(){
    const now=new Date();
    document.getElementById("lastUpdated").innerText=`Updated: ${now.toLocaleTimeString()}`;
}

function logout(){ localStorage.removeItem("agent"); location.reload(); }

document.addEventListener("visibilitychange", () => {
    if (!document.hidden) {
        newTaskCount = 0;
        updateFavicon(0);
    }
});

function updateTotalTasks(filteredTasks=null){
    const el = document.getElementById("totalTasksSummary");
    const loginName = localStorage.getItem("agent");
    if(!loginName) return;

    const data = filteredTasks || tasks.filter(t => t["Agent Assigned"] === loginName);
    el.innerHTML = `<div>Total Tasks: ${data.length}</div>`;
}
</script>
</body>
</html>
